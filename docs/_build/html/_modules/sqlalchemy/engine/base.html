
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>sqlalchemy.engine.base &#8212; zenq 0.1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for sqlalchemy.engine.base</h1><div class="highlight"><pre>
<span></span><span class="c1"># engine/base.py</span>
<span class="c1"># Copyright (C) 2005-2023 the SQLAlchemy authors and contributors</span>
<span class="c1"># &lt;see AUTHORS file&gt;</span>
<span class="c1">#</span>
<span class="c1"># This module is part of SQLAlchemy and is released under</span>
<span class="c1"># the MIT License: https://www.opensource.org/licenses/mit-license.php</span>
<span class="sd">&quot;&quot;&quot;Defines :class:`_engine.Connection` and :class:`_engine.Engine`.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">cast</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterable</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterator</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Mapping</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">NoReturn</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">overload</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Type</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TypeVar</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>

<span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">BindTyping</span>
<span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">ConnectionEventsTarget</span>
<span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">DBAPICursor</span>
<span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">ExceptionContext</span>
<span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">ExecuteStyle</span>
<span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">ExecutionContext</span>
<span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">IsolationLevel</span>
<span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">_distill_params_20</span>
<span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">_distill_raw_params</span>
<span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">TransactionalContext</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">exc</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">inspection</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">log</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">util</span>
<span class="kn">from</span> <span class="nn">..sql</span> <span class="kn">import</span> <span class="n">compiler</span>
<span class="kn">from</span> <span class="nn">..sql</span> <span class="kn">import</span> <span class="n">util</span> <span class="k">as</span> <span class="n">sql_util</span>

<span class="k">if</span> <span class="n">typing</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">CursorResult</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">ScalarResult</span>
    <span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">_AnyExecuteParams</span>
    <span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">_AnyMultiExecuteParams</span>
    <span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">_CoreAnyExecuteParams</span>
    <span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">_CoreMultiExecuteParams</span>
    <span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">_CoreSingleExecuteParams</span>
    <span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">_DBAPIAnyExecuteParams</span>
    <span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">_DBAPISingleExecuteParams</span>
    <span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">_ExecuteOptions</span>
    <span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">CompiledCacheType</span>
    <span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">CoreExecuteOptionsParameter</span>
    <span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">Dialect</span>
    <span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">SchemaTranslateMapType</span>
    <span class="kn">from</span> <span class="nn">.reflection</span> <span class="kn">import</span> <span class="n">Inspector</span>  <span class="c1"># noqa</span>
    <span class="kn">from</span> <span class="nn">.url</span> <span class="kn">import</span> <span class="n">URL</span>
    <span class="kn">from</span> <span class="nn">..event</span> <span class="kn">import</span> <span class="n">dispatcher</span>
    <span class="kn">from</span> <span class="nn">..log</span> <span class="kn">import</span> <span class="n">_EchoFlagType</span>
    <span class="kn">from</span> <span class="nn">..pool</span> <span class="kn">import</span> <span class="n">_ConnectionFairy</span>
    <span class="kn">from</span> <span class="nn">..pool</span> <span class="kn">import</span> <span class="n">Pool</span>
    <span class="kn">from</span> <span class="nn">..pool</span> <span class="kn">import</span> <span class="n">PoolProxiedConnection</span>
    <span class="kn">from</span> <span class="nn">..sql</span> <span class="kn">import</span> <span class="n">Executable</span>
    <span class="kn">from</span> <span class="nn">..sql._typing</span> <span class="kn">import</span> <span class="n">_InfoType</span>
    <span class="kn">from</span> <span class="nn">..sql.compiler</span> <span class="kn">import</span> <span class="n">Compiled</span>
    <span class="kn">from</span> <span class="nn">..sql.ddl</span> <span class="kn">import</span> <span class="n">ExecutableDDLElement</span>
    <span class="kn">from</span> <span class="nn">..sql.ddl</span> <span class="kn">import</span> <span class="n">SchemaDropper</span>
    <span class="kn">from</span> <span class="nn">..sql.ddl</span> <span class="kn">import</span> <span class="n">SchemaGenerator</span>
    <span class="kn">from</span> <span class="nn">..sql.functions</span> <span class="kn">import</span> <span class="n">FunctionElement</span>
    <span class="kn">from</span> <span class="nn">..sql.schema</span> <span class="kn">import</span> <span class="n">DefaultGenerator</span>
    <span class="kn">from</span> <span class="nn">..sql.schema</span> <span class="kn">import</span> <span class="n">HasSchemaAttr</span>
    <span class="kn">from</span> <span class="nn">..sql.schema</span> <span class="kn">import</span> <span class="n">SchemaItem</span>
    <span class="kn">from</span> <span class="nn">..sql.selectable</span> <span class="kn">import</span> <span class="n">TypedReturnsRows</span>


<span class="n">_T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_T&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">Any</span><span class="p">)</span>
<span class="n">_EMPTY_EXECUTION_OPTS</span><span class="p">:</span> <span class="n">_ExecuteOptions</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span>
<span class="n">NO_OPTIONS</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span>


<span class="k">class</span> <span class="nc">Connection</span><span class="p">(</span><span class="n">ConnectionEventsTarget</span><span class="p">,</span> <span class="n">inspection</span><span class="o">.</span><span class="n">Inspectable</span><span class="p">[</span><span class="s2">&quot;Inspector&quot;</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provides high-level functionality for a wrapped DB-API connection.</span>

<span class="sd">    The :class:`_engine.Connection` object is procured by calling the</span>
<span class="sd">    :meth:`_engine.Engine.connect` method of the :class:`_engine.Engine`</span>
<span class="sd">    object, and provides services for execution of SQL statements as well</span>
<span class="sd">    as transaction control.</span>

<span class="sd">    The Connection object is **not** thread-safe. While a Connection can be</span>
<span class="sd">    shared among threads using properly synchronized access, it is still</span>
<span class="sd">    possible that the underlying DBAPI connection may not support shared</span>
<span class="sd">    access between threads. Check the DBAPI documentation for details.</span>

<span class="sd">    The Connection object represents a single DBAPI connection checked out</span>
<span class="sd">    from the connection pool. In this state, the connection pool has no</span>
<span class="sd">    affect upon the connection, including its expiration or timeout state.</span>
<span class="sd">    For the connection pool to properly manage connections, connections</span>
<span class="sd">    should be returned to the connection pool (i.e. ``connection.close()``)</span>
<span class="sd">    whenever the connection is not in use.</span>

<span class="sd">    .. index::</span>
<span class="sd">      single: thread safety; Connection</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dispatch</span><span class="p">:</span> <span class="n">dispatcher</span><span class="p">[</span><span class="n">ConnectionEventsTarget</span><span class="p">]</span>

    <span class="n">_sqla_logger_namespace</span> <span class="o">=</span> <span class="s2">&quot;sqlalchemy.engine.Connection&quot;</span>

    <span class="c1"># used by sqlalchemy.engine.util.TransactionalContext</span>
    <span class="n">_trans_context_manager</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TransactionalContext</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># legacy as of 2.0, should be eventually deprecated and</span>
    <span class="c1"># removed.  was used in the &quot;pre_ping&quot; recipe that&#39;s been in the docs</span>
    <span class="c1"># a long time</span>
    <span class="n">should_close_with_result</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">_dbapi_connection</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PoolProxiedConnection</span><span class="p">]</span>

    <span class="n">_execution_options</span><span class="p">:</span> <span class="n">_ExecuteOptions</span>

    <span class="n">_transaction</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RootTransaction</span><span class="p">]</span>
    <span class="n">_nested_transaction</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">NestedTransaction</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">engine</span><span class="p">:</span> <span class="n">Engine</span><span class="p">,</span>
        <span class="n">connection</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PoolProxiedConnection</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">_has_events</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">_allow_revalidate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">_allow_autobegin</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct a new Connection.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="n">engine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span> <span class="o">=</span> <span class="n">dialect</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">dialect</span>

        <span class="k">if</span> <span class="n">connection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dbapi_connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">raw_connection</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">dialect</span><span class="o">.</span><span class="n">loaded_dbapi</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">Connection</span><span class="o">.</span><span class="n">_handle_dbapi_exception_noconnection</span><span class="p">(</span>
                    <span class="n">err</span><span class="p">,</span> <span class="n">dialect</span><span class="p">,</span> <span class="n">engine</span>
                <span class="p">)</span>
                <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dbapi_connection</span> <span class="o">=</span> <span class="n">connection</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nested_transaction</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__savepoint_seq</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__in_begin</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__can_reconnect</span> <span class="o">=</span> <span class="n">_allow_revalidate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_allow_autobegin</span> <span class="o">=</span> <span class="n">_allow_autobegin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_echo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_should_log_info</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">_has_events</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># if _has_events is sent explicitly as False,</span>
            <span class="c1"># then don&#39;t join the dispatch of the engine; we don&#39;t</span>
            <span class="c1"># want to handle any of the engine&#39;s events in that case.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">_join</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">dispatch</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has_events</span> <span class="o">=</span> <span class="n">_has_events</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">_has_events</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">engine</span><span class="o">.</span><span class="n">_has_events</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_execution_options</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">_execution_options</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_events</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_has_events</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">engine_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@util</span><span class="o">.</span><span class="n">memoized_property</span>
    <span class="k">def</span> <span class="nf">_message_formatter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;logging_token&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execution_options</span><span class="p">:</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execution_options</span><span class="p">[</span><span class="s2">&quot;logging_token&quot;</span><span class="p">]</span>
            <span class="k">return</span> <span class="k">lambda</span> <span class="n">msg</span><span class="p">:</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">] </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_log_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_message_formatter</span>

        <span class="k">if</span> <span class="n">fmt</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">STACKLEVEL</span><span class="p">:</span>
            <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;stacklevel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">log</span><span class="o">.</span><span class="n">STACKLEVEL_OFFSET</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_log_debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">arg</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_message_formatter</span>

        <span class="k">if</span> <span class="n">fmt</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">STACKLEVEL</span><span class="p">:</span>
            <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;stacklevel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">log</span><span class="o">.</span><span class="n">STACKLEVEL_OFFSET</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_schema_translate_map</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SchemaTranslateMapType</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execution_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;schema_translate_map&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">schema_for_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">HasSchemaAttr</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the schema name for the given schema item taking into</span>
<span class="sd">        account current schema translate map.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">schema</span>
        <span class="n">schema_translate_map</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
            <span class="n">SchemaTranslateMapType</span>
        <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execution_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;schema_translate_map&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">schema_translate_map</span>
            <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">schema_translate_map</span>
            <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">_use_schema_map</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">schema_translate_map</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">name</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Connection</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">traceback</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">execution_options</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">compiled_cache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CompiledCacheType</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
        <span class="n">logging_token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
        <span class="n">isolation_level</span><span class="p">:</span> <span class="n">IsolationLevel</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
        <span class="n">no_parameters</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">stream_results</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">max_row_buffer</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
        <span class="n">yield_per</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
        <span class="n">insertmanyvalues_page_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
        <span class="n">schema_translate_map</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SchemaTranslateMapType</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
        <span class="o">**</span><span class="n">opt</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Connection</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">execution_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">opt</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Connection</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">execution_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">opt</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Connection</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Set non-SQL options for the connection which take effect</span>
<span class="sd">        during execution.</span>

<span class="sd">        This method modifies this :class:`_engine.Connection` **in-place**;</span>
<span class="sd">        the return value is the same :class:`_engine.Connection` object</span>
<span class="sd">        upon which the method is called.   Note that this is in contrast</span>
<span class="sd">        to the behavior of the ``execution_options`` methods on other</span>
<span class="sd">        objects such as :meth:`_engine.Engine.execution_options` and</span>
<span class="sd">        :meth:`_sql.Executable.execution_options`.  The rationale is that many</span>
<span class="sd">        such execution options necessarily modify the state of the base</span>
<span class="sd">        DBAPI connection in any case so there is no feasible means of</span>
<span class="sd">        keeping the effect of such an option localized to a &quot;sub&quot; connection.</span>

<span class="sd">        .. versionchanged:: 2.0  The :meth:`_engine.Connection.execution_options`</span>
<span class="sd">           method, in contrast to other objects with this method, modifies</span>
<span class="sd">           the connection in-place without creating copy of it.</span>

<span class="sd">        As discussed elsewhere, the :meth:`_engine.Connection.execution_options`</span>
<span class="sd">        method accepts any arbitrary parameters including user defined names.</span>
<span class="sd">        All parameters given are consumable in a number of ways including</span>
<span class="sd">        by using the :meth:`_engine.Connection.get_execution_options` method.</span>
<span class="sd">        See the examples at :meth:`_sql.Executable.execution_options`</span>
<span class="sd">        and :meth:`_engine.Engine.execution_options`.</span>

<span class="sd">        The keywords that are currently recognized by SQLAlchemy itself</span>
<span class="sd">        include all those listed under :meth:`.Executable.execution_options`,</span>
<span class="sd">        as well as others that are specific to :class:`_engine.Connection`.</span>

<span class="sd">        :param compiled_cache: Available on: :class:`_engine.Connection`,</span>
<span class="sd">          :class:`_engine.Engine`.</span>

<span class="sd">          A dictionary where :class:`.Compiled` objects</span>
<span class="sd">          will be cached when the :class:`_engine.Connection`</span>
<span class="sd">          compiles a clause</span>
<span class="sd">          expression into a :class:`.Compiled` object.  This dictionary will</span>
<span class="sd">          supersede the statement cache that may be configured on the</span>
<span class="sd">          :class:`_engine.Engine` itself.   If set to None, caching</span>
<span class="sd">          is disabled, even if the engine has a configured cache size.</span>

<span class="sd">          Note that the ORM makes use of its own &quot;compiled&quot; caches for</span>
<span class="sd">          some operations, including flush operations.  The caching</span>
<span class="sd">          used by the ORM internally supersedes a cache dictionary</span>
<span class="sd">          specified here.</span>

<span class="sd">        :param logging_token: Available on: :class:`_engine.Connection`,</span>
<span class="sd">          :class:`_engine.Engine`, :class:`_sql.Executable`.</span>

<span class="sd">          Adds the specified string token surrounded by brackets in log</span>
<span class="sd">          messages logged by the connection, i.e. the logging that&#39;s enabled</span>
<span class="sd">          either via the :paramref:`_sa.create_engine.echo` flag or via the</span>
<span class="sd">          ``logging.getLogger(&quot;sqlalchemy.engine&quot;)`` logger. This allows a</span>
<span class="sd">          per-connection or per-sub-engine token to be available which is</span>
<span class="sd">          useful for debugging concurrent connection scenarios.</span>

<span class="sd">          .. versionadded:: 1.4.0b2</span>

<span class="sd">          .. seealso::</span>

<span class="sd">            :ref:`dbengine_logging_tokens` - usage example</span>

<span class="sd">            :paramref:`_sa.create_engine.logging_name` - adds a name to the</span>
<span class="sd">            name used by the Python logger object itself.</span>

<span class="sd">        :param isolation_level: Available on: :class:`_engine.Connection`,</span>
<span class="sd">          :class:`_engine.Engine`.</span>

<span class="sd">          Set the transaction isolation level for the lifespan of this</span>
<span class="sd">          :class:`_engine.Connection` object.</span>
<span class="sd">          Valid values include those string</span>
<span class="sd">          values accepted by the :paramref:`_sa.create_engine.isolation_level`</span>
<span class="sd">          parameter passed to :func:`_sa.create_engine`.  These levels are</span>
<span class="sd">          semi-database specific; see individual dialect documentation for</span>
<span class="sd">          valid levels.</span>

<span class="sd">          The isolation level option applies the isolation level by emitting</span>
<span class="sd">          statements on the DBAPI connection, and **necessarily affects the</span>
<span class="sd">          original Connection object overall**. The isolation level will remain</span>
<span class="sd">          at the given setting until explicitly changed, or when the DBAPI</span>
<span class="sd">          connection itself is :term:`released` to the connection pool, i.e. the</span>
<span class="sd">          :meth:`_engine.Connection.close` method is called, at which time an</span>
<span class="sd">          event handler will emit additional statements on the DBAPI connection</span>
<span class="sd">          in order to revert the isolation level change.</span>

<span class="sd">          .. note:: The ``isolation_level`` execution option may only be</span>
<span class="sd">             established before the :meth:`_engine.Connection.begin` method is</span>
<span class="sd">             called, as well as before any SQL statements are emitted which</span>
<span class="sd">             would otherwise trigger &quot;autobegin&quot;, or directly after a call to</span>
<span class="sd">             :meth:`_engine.Connection.commit` or</span>
<span class="sd">             :meth:`_engine.Connection.rollback`. A database cannot change the</span>
<span class="sd">             isolation level on a transaction in progress.</span>

<span class="sd">          .. note:: The ``isolation_level`` execution option is implicitly</span>
<span class="sd">             reset if the :class:`_engine.Connection` is invalidated, e.g. via</span>
<span class="sd">             the :meth:`_engine.Connection.invalidate` method, or if a</span>
<span class="sd">             disconnection error occurs. The new connection produced after the</span>
<span class="sd">             invalidation will **not** have the selected isolation level</span>
<span class="sd">             re-applied to it automatically.</span>

<span class="sd">          .. seealso::</span>

<span class="sd">                :ref:`dbapi_autocommit`</span>

<span class="sd">                :meth:`_engine.Connection.get_isolation_level`</span>
<span class="sd">                - view current actual level</span>

<span class="sd">        :param no_parameters: Available on: :class:`_engine.Connection`,</span>
<span class="sd">          :class:`_sql.Executable`.</span>

<span class="sd">          When ``True``, if the final parameter</span>
<span class="sd">          list or dictionary is totally empty, will invoke the</span>
<span class="sd">          statement on the cursor as ``cursor.execute(statement)``,</span>
<span class="sd">          not passing the parameter collection at all.</span>
<span class="sd">          Some DBAPIs such as psycopg2 and mysql-python consider</span>
<span class="sd">          percent signs as significant only when parameters are</span>
<span class="sd">          present; this option allows code to generate SQL</span>
<span class="sd">          containing percent signs (and possibly other characters)</span>
<span class="sd">          that is neutral regarding whether it&#39;s executed by the DBAPI</span>
<span class="sd">          or piped into a script that&#39;s later invoked by</span>
<span class="sd">          command line tools.</span>

<span class="sd">        :param stream_results: Available on: :class:`_engine.Connection`,</span>
<span class="sd">          :class:`_sql.Executable`.</span>

<span class="sd">          Indicate to the dialect that results should be</span>
<span class="sd">          &quot;streamed&quot; and not pre-buffered, if possible.  For backends</span>
<span class="sd">          such as PostgreSQL, MySQL and MariaDB, this indicates the use of</span>
<span class="sd">          a &quot;server side cursor&quot; as opposed to a client side cursor.</span>
<span class="sd">          Other backends such as that of Oracle may already use server</span>
<span class="sd">          side cursors by default.</span>

<span class="sd">          The usage of</span>
<span class="sd">          :paramref:`_engine.Connection.execution_options.stream_results` is</span>
<span class="sd">          usually combined with setting a fixed number of rows to to be fetched</span>
<span class="sd">          in batches, to allow for efficient iteration of database rows while</span>
<span class="sd">          at the same time not loading all result rows into memory at once;</span>
<span class="sd">          this can be configured on a :class:`_engine.Result` object using the</span>
<span class="sd">          :meth:`_engine.Result.yield_per` method, after execution has</span>
<span class="sd">          returned a new :class:`_engine.Result`.   If</span>
<span class="sd">          :meth:`_engine.Result.yield_per` is not used,</span>
<span class="sd">          the :paramref:`_engine.Connection.execution_options.stream_results`</span>
<span class="sd">          mode of operation will instead use a dynamically sized buffer</span>
<span class="sd">          which buffers sets of rows at a time, growing on each batch</span>
<span class="sd">          based on a fixed growth size up until a limit which may</span>
<span class="sd">          be configured using the</span>
<span class="sd">          :paramref:`_engine.Connection.execution_options.max_row_buffer`</span>
<span class="sd">          parameter.</span>

<span class="sd">          When using the ORM to fetch ORM mapped objects from a result,</span>
<span class="sd">          :meth:`_engine.Result.yield_per` should always be used with</span>
<span class="sd">          :paramref:`_engine.Connection.execution_options.stream_results`,</span>
<span class="sd">          so that the ORM does not fetch all rows into new ORM objects at once.</span>

<span class="sd">          For typical use, the</span>
<span class="sd">          :paramref:`_engine.Connection.execution_options.yield_per` execution</span>
<span class="sd">          option should be preferred, which sets up both</span>
<span class="sd">          :paramref:`_engine.Connection.execution_options.stream_results` and</span>
<span class="sd">          :meth:`_engine.Result.yield_per` at once. This option is supported</span>
<span class="sd">          both at a core level by :class:`_engine.Connection` as well as by the</span>
<span class="sd">          ORM :class:`_engine.Session`; the latter is described at</span>
<span class="sd">          :ref:`orm_queryguide_yield_per`.</span>

<span class="sd">          .. seealso::</span>

<span class="sd">            :ref:`engine_stream_results` - background on</span>
<span class="sd">            :paramref:`_engine.Connection.execution_options.stream_results`</span>

<span class="sd">            :paramref:`_engine.Connection.execution_options.max_row_buffer`</span>

<span class="sd">            :paramref:`_engine.Connection.execution_options.yield_per`</span>

<span class="sd">            :ref:`orm_queryguide_yield_per` - in the :ref:`queryguide_toplevel`</span>
<span class="sd">            describing the ORM version of ``yield_per``</span>

<span class="sd">        :param max_row_buffer: Available on: :class:`_engine.Connection`,</span>
<span class="sd">          :class:`_sql.Executable`.  Sets a maximum</span>
<span class="sd">          buffer size to use when the</span>
<span class="sd">          :paramref:`_engine.Connection.execution_options.stream_results`</span>
<span class="sd">          execution option is used on a backend that supports server side</span>
<span class="sd">          cursors.  The default value if not specified is 1000.</span>

<span class="sd">          .. seealso::</span>

<span class="sd">            :paramref:`_engine.Connection.execution_options.stream_results`</span>

<span class="sd">            :ref:`engine_stream_results`</span>


<span class="sd">        :param yield_per: Available on: :class:`_engine.Connection`,</span>
<span class="sd">          :class:`_sql.Executable`.  Integer value applied which will</span>
<span class="sd">          set the :paramref:`_engine.Connection.execution_options.stream_results`</span>
<span class="sd">          execution option and invoke :meth:`_engine.Result.yield_per`</span>
<span class="sd">          automatically at once.  Allows equivalent functionality as</span>
<span class="sd">          is present when using this parameter with the ORM.</span>

<span class="sd">          .. versionadded:: 1.4.40</span>

<span class="sd">          .. seealso::</span>

<span class="sd">            :ref:`engine_stream_results` - background and examples</span>
<span class="sd">            on using server side cursors with Core.</span>

<span class="sd">            :ref:`orm_queryguide_yield_per` - in the :ref:`queryguide_toplevel`</span>
<span class="sd">            describing the ORM version of ``yield_per``</span>

<span class="sd">        :param insertmanyvalues_page_size: Available on: :class:`_engine.Connection`,</span>
<span class="sd">            :class:`_engine.Engine`. Number of rows to format into an</span>
<span class="sd">            INSERT statement when the statement uses &quot;insertmanyvalues&quot; mode,</span>
<span class="sd">            which is a paged form of bulk insert that is used for many backends</span>
<span class="sd">            when using :term:`executemany` execution typically in conjunction</span>
<span class="sd">            with RETURNING. Defaults to 1000. May also be modified on a</span>
<span class="sd">            per-engine basis using the</span>
<span class="sd">            :paramref:`_sa.create_engine.insertmanyvalues_page_size` parameter.</span>

<span class="sd">            .. versionadded:: 2.0</span>

<span class="sd">            .. seealso::</span>

<span class="sd">                :ref:`engine_insertmanyvalues`</span>

<span class="sd">        :param schema_translate_map: Available on: :class:`_engine.Connection`,</span>
<span class="sd">          :class:`_engine.Engine`, :class:`_sql.Executable`.</span>

<span class="sd">          A dictionary mapping schema names to schema names, that will be</span>
<span class="sd">          applied to the :paramref:`_schema.Table.schema` element of each</span>
<span class="sd">          :class:`_schema.Table`</span>
<span class="sd">          encountered when SQL or DDL expression elements</span>
<span class="sd">          are compiled into strings; the resulting schema name will be</span>
<span class="sd">          converted based on presence in the map of the original name.</span>

<span class="sd">          .. seealso::</span>

<span class="sd">            :ref:`schema_translating`</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            :meth:`_engine.Engine.execution_options`</span>

<span class="sd">            :meth:`.Executable.execution_options`</span>

<span class="sd">            :meth:`_engine.Connection.get_execution_options`</span>

<span class="sd">            :ref:`orm_queryguide_execution_options` - documentation on all</span>
<span class="sd">            ORM-specific execution options</span>

<span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_events</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_has_events</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">set_connection_execution_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_execution_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execution_options</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">set_connection_execution_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">get_execution_options</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_ExecuteOptions</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the non-SQL options which will take effect during execution.</span>

<span class="sd">        .. versionadded:: 1.3</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            :meth:`_engine.Connection.execution_options`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execution_options</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_still_open_and_dbapi_connection_is_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">pool_proxied_connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbapi_connection</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">pool_proxied_connection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">pool_proxied_connection</span><span class="o">.</span><span class="n">is_valid</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">closed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if this connection is closed.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbapi_connection</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__can_reconnect</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">invalidated</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if this connection was invalidated.</span>

<span class="sd">        This does not indicate whether or not the connection was</span>
<span class="sd">        invalidated at the pool level, however</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># prior to 1.4, &quot;invalid&quot; was stored as a state independent of</span>
        <span class="c1"># &quot;closed&quot;, meaning an invalidated connection could be &quot;closed&quot;,</span>
        <span class="c1"># the _dbapi_connection would be None and closed=True, yet the</span>
        <span class="c1"># &quot;invalid&quot; flag would stay True.  This meant that there were</span>
        <span class="c1"># three separate states (open/valid, closed/valid, closed/invalid)</span>
        <span class="c1"># when there is really no reason for that; a connection that&#39;s</span>
        <span class="c1"># &quot;closed&quot; does not need to be &quot;invalid&quot;.  So the state is now</span>
        <span class="c1"># represented by the two facts alone.</span>

        <span class="n">pool_proxied_connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbapi_connection</span>
        <span class="k">return</span> <span class="n">pool_proxied_connection</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__can_reconnect</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">connection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PoolProxiedConnection</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The underlying DB-API connection managed by this Connection.</span>

<span class="sd">        This is a SQLAlchemy connection-pool proxied connection</span>
<span class="sd">        which then has the attribute</span>
<span class="sd">        :attr:`_pool._ConnectionFairy.dbapi_connection` that refers to the</span>
<span class="sd">        actual driver connection.</span>

<span class="sd">        .. seealso::</span>


<span class="sd">            :ref:`dbapi_connections`</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbapi_connection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_revalidate_connection</span><span class="p">()</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">PendingRollbackError</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">ResourceClosedError</span><span class="p">):</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_handle_dbapi_exception</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbapi_connection</span>

    <span class="k">def</span> <span class="nf">get_isolation_level</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IsolationLevel</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the current **actual** isolation level that&#39;s present on</span>
<span class="sd">        the database within the scope of this connection.</span>

<span class="sd">        This attribute will perform a live SQL operation against the database</span>
<span class="sd">        in order to procure the current isolation level, so the value returned</span>
<span class="sd">        is the actual level on the underlying DBAPI connection regardless of</span>
<span class="sd">        how this state was set. This will be one of the four actual isolation</span>
<span class="sd">        modes ``READ UNCOMMITTED``, ``READ COMMITTED``, ``REPEATABLE READ``,</span>
<span class="sd">        ``SERIALIZABLE``. It will **not** include the ``AUTOCOMMIT`` isolation</span>
<span class="sd">        level setting. Third party dialects may also feature additional</span>
<span class="sd">        isolation level settings.</span>

<span class="sd">        .. note::  This method **will not report** on the ``AUTOCOMMIT``</span>
<span class="sd">          isolation level, which is a separate :term:`dbapi` setting that&#39;s</span>
<span class="sd">          independent of **actual** isolation level.  When ``AUTOCOMMIT`` is</span>
<span class="sd">          in use, the database connection still has a &quot;traditional&quot; isolation</span>
<span class="sd">          mode in effect, that is typically one of the four values</span>
<span class="sd">          ``READ UNCOMMITTED``, ``READ COMMITTED``, ``REPEATABLE READ``,</span>
<span class="sd">          ``SERIALIZABLE``.</span>

<span class="sd">        Compare to the :attr:`_engine.Connection.default_isolation_level`</span>
<span class="sd">        accessor which returns the isolation level that is present on the</span>
<span class="sd">        database at initial connection time.</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            :attr:`_engine.Connection.default_isolation_level`</span>
<span class="sd">            - view default level</span>

<span class="sd">            :paramref:`_sa.create_engine.isolation_level`</span>
<span class="sd">            - set per :class:`_engine.Engine` isolation level</span>

<span class="sd">            :paramref:`.Connection.execution_options.isolation_level`</span>
<span class="sd">            - set per :class:`_engine.Connection` isolation level</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dbapi_connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">dbapi_connection</span>
        <span class="k">assert</span> <span class="n">dbapi_connection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">get_isolation_level</span><span class="p">(</span><span class="n">dbapi_connection</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_dbapi_exception</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">default_isolation_level</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">IsolationLevel</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The initial-connection time isolation level associated with the</span>
<span class="sd">        :class:`_engine.Dialect` in use.</span>

<span class="sd">        This value is independent of the</span>
<span class="sd">        :paramref:`.Connection.execution_options.isolation_level` and</span>
<span class="sd">        :paramref:`.Engine.execution_options.isolation_level` execution</span>
<span class="sd">        options, and is determined by the :class:`_engine.Dialect` when the</span>
<span class="sd">        first connection is created, by performing a SQL query against the</span>
<span class="sd">        database for the current isolation level before any additional commands</span>
<span class="sd">        have been emitted.</span>

<span class="sd">        Calling this accessor does not invoke any new SQL queries.</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            :meth:`_engine.Connection.get_isolation_level`</span>
<span class="sd">            - view current actual isolation level</span>

<span class="sd">            :paramref:`_sa.create_engine.isolation_level`</span>
<span class="sd">            - set per :class:`_engine.Engine` isolation level</span>

<span class="sd">            :paramref:`.Connection.execution_options.isolation_level`</span>
<span class="sd">            - set per :class:`_engine.Connection` isolation level</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">default_isolation_level</span>

    <span class="k">def</span> <span class="nf">_invalid_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">PendingRollbackError</span><span class="p">(</span>
            <span class="s2">&quot;Can&#39;t reconnect until invalid </span><span class="si">%s</span><span class="s2">transaction is rolled &quot;</span>
            <span class="s2">&quot;back.  Please rollback() fully before proceeding&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;savepoint &quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nested_transaction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="n">code</span><span class="o">=</span><span class="s2">&quot;8s2b&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_revalidate_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PoolProxiedConnection</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__can_reconnect</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">invalidated</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_invalid_transaction</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dbapi_connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">raw_connection</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbapi_connection</span>
        <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ResourceClosedError</span><span class="p">(</span><span class="s2">&quot;This Connection is closed&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_InfoType</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Info dictionary associated with the underlying DBAPI connection</span>
<span class="sd">        referred to by this :class:`_engine.Connection`, allowing user-defined</span>
<span class="sd">        data to be associated with the connection.</span>

<span class="sd">        The data here will follow along with the DBAPI connection including</span>
<span class="sd">        after it is returned to the connection pool and used again</span>
<span class="sd">        in subsequent instances of :class:`_engine.Connection`.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">info</span>

    <span class="k">def</span> <span class="nf">invalidate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exception</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Invalidate the underlying DBAPI connection associated with</span>
<span class="sd">        this :class:`_engine.Connection`.</span>

<span class="sd">        An attempt will be made to close the underlying DBAPI connection</span>
<span class="sd">        immediately; however if this operation fails, the error is logged</span>
<span class="sd">        but not raised.  The connection is then discarded whether or not</span>
<span class="sd">        close() succeeded.</span>

<span class="sd">        Upon the next use (where &quot;use&quot; typically means using the</span>
<span class="sd">        :meth:`_engine.Connection.execute` method or similar),</span>
<span class="sd">        this :class:`_engine.Connection` will attempt to</span>
<span class="sd">        procure a new DBAPI connection using the services of the</span>
<span class="sd">        :class:`_pool.Pool` as a source of connectivity (e.g.</span>
<span class="sd">        a &quot;reconnection&quot;).</span>

<span class="sd">        If a transaction was in progress (e.g. the</span>
<span class="sd">        :meth:`_engine.Connection.begin` method has been called) when</span>
<span class="sd">        :meth:`_engine.Connection.invalidate` method is called, at the DBAPI</span>
<span class="sd">        level all state associated with this transaction is lost, as</span>
<span class="sd">        the DBAPI connection is closed.  The :class:`_engine.Connection`</span>
<span class="sd">        will not allow a reconnection to proceed until the</span>
<span class="sd">        :class:`.Transaction` object is ended, by calling the</span>
<span class="sd">        :meth:`.Transaction.rollback` method; until that point, any attempt at</span>
<span class="sd">        continuing to use the :class:`_engine.Connection` will raise an</span>
<span class="sd">        :class:`~sqlalchemy.exc.InvalidRequestError`.</span>
<span class="sd">        This is to prevent applications from accidentally</span>
<span class="sd">        continuing an ongoing transactional operations despite the</span>
<span class="sd">        fact that the transaction has been lost due to an</span>
<span class="sd">        invalidation.</span>

<span class="sd">        The :meth:`_engine.Connection.invalidate` method,</span>
<span class="sd">        just like auto-invalidation,</span>
<span class="sd">        will at the connection pool level invoke the</span>
<span class="sd">        :meth:`_events.PoolEvents.invalidate` event.</span>

<span class="sd">        :param exception: an optional ``Exception`` instance that&#39;s the</span>
<span class="sd">         reason for the invalidation.  is passed along to event handlers</span>
<span class="sd">         and logging functions.</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            :ref:`pool_connection_invalidation`</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">invalidated</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ResourceClosedError</span><span class="p">(</span><span class="s2">&quot;This Connection is closed&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_still_open_and_dbapi_connection_is_valid</span><span class="p">:</span>
            <span class="n">pool_proxied_connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbapi_connection</span>
            <span class="k">assert</span> <span class="n">pool_proxied_connection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">pool_proxied_connection</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dbapi_connection</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">detach</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Detach the underlying DB-API connection from its connection pool.</span>

<span class="sd">        E.g.::</span>

<span class="sd">            with engine.connect() as conn:</span>
<span class="sd">                conn.detach()</span>
<span class="sd">                conn.execute(text(&quot;SET search_path TO schema1, schema2&quot;))</span>

<span class="sd">                # work with connection</span>

<span class="sd">            # connection is fully closed (since we used &quot;with:&quot;, can</span>
<span class="sd">            # also call .close())</span>

<span class="sd">        This :class:`_engine.Connection` instance will remain usable.</span>
<span class="sd">        When closed</span>
<span class="sd">        (or exited from a context manager context as above),</span>
<span class="sd">        the DB-API connection will be literally closed and not</span>
<span class="sd">        returned to its originating pool.</span>

<span class="sd">        This method can be used to insulate the rest of an application</span>
<span class="sd">        from a modified state on a connection (such as a transaction</span>
<span class="sd">        isolation level or similar).</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ResourceClosedError</span><span class="p">(</span><span class="s2">&quot;This Connection is closed&quot;</span><span class="p">)</span>

        <span class="n">pool_proxied_connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbapi_connection</span>
        <span class="k">if</span> <span class="n">pool_proxied_connection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                <span class="s2">&quot;Can&#39;t detach an invalidated Connection&quot;</span>
            <span class="p">)</span>
        <span class="n">pool_proxied_connection</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_autobegin</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allow_autobegin</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__in_begin</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">begin</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RootTransaction</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Begin a transaction prior to autobegin occurring.</span>

<span class="sd">        E.g.::</span>

<span class="sd">            with engine.connect() as conn:</span>
<span class="sd">                with conn.begin() as trans:</span>
<span class="sd">                    conn.execute(table.insert(), {&quot;username&quot;: &quot;sandy&quot;})</span>


<span class="sd">        The returned object is an instance of :class:`_engine.RootTransaction`.</span>
<span class="sd">        This object represents the &quot;scope&quot; of the transaction,</span>
<span class="sd">        which completes when either the :meth:`_engine.Transaction.rollback`</span>
<span class="sd">        or :meth:`_engine.Transaction.commit` method is called; the object</span>
<span class="sd">        also works as a context manager as illustrated above.</span>

<span class="sd">        The :meth:`_engine.Connection.begin` method begins a</span>
<span class="sd">        transaction that normally will be begun in any case when the connection</span>
<span class="sd">        is first used to execute a statement.  The reason this method might be</span>
<span class="sd">        used would be to invoke the :meth:`_events.ConnectionEvents.begin`</span>
<span class="sd">        event at a specific time, or to organize code within the scope of a</span>
<span class="sd">        connection checkout in terms of context managed blocks, such as::</span>

<span class="sd">            with engine.connect() as conn:</span>
<span class="sd">                with conn.begin():</span>
<span class="sd">                    conn.execute(...)</span>
<span class="sd">                    conn.execute(...)</span>

<span class="sd">                with conn.begin():</span>
<span class="sd">                    conn.execute(...)</span>
<span class="sd">                    conn.execute(...)</span>

<span class="sd">        The above code is not  fundamentally any different in its behavior than</span>
<span class="sd">        the following code  which does not use</span>
<span class="sd">        :meth:`_engine.Connection.begin`; the below style is referred towards</span>
<span class="sd">        as &quot;commit as you go&quot; style::</span>

<span class="sd">            with engine.connect() as conn:</span>
<span class="sd">                conn.execute(...)</span>
<span class="sd">                conn.execute(...)</span>
<span class="sd">                conn.commit()</span>

<span class="sd">                conn.execute(...)</span>
<span class="sd">                conn.execute(...)</span>
<span class="sd">                conn.commit()</span>

<span class="sd">        From a database point of view, the :meth:`_engine.Connection.begin`</span>
<span class="sd">        method does not emit any SQL or change the state of the underlying</span>
<span class="sd">        DBAPI connection in any way; the Python DBAPI does not have any</span>
<span class="sd">        concept of explicit transaction begin.</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            :ref:`tutorial_working_with_transactions` - in the</span>
<span class="sd">            :ref:`unified_tutorial`</span>

<span class="sd">            :meth:`_engine.Connection.begin_nested` - use a SAVEPOINT</span>

<span class="sd">            :meth:`_engine.Connection.begin_twophase` -</span>
<span class="sd">            use a two phase /XID transaction</span>

<span class="sd">            :meth:`_engine.Engine.begin` - context manager available from</span>
<span class="sd">            :class:`_engine.Engine`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span> <span class="o">=</span> <span class="n">RootTransaction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                <span class="s2">&quot;This connection has already initialized a SQLAlchemy &quot;</span>
                <span class="s2">&quot;Transaction() object via begin() or autobegin; can&#39;t &quot;</span>
                <span class="s2">&quot;call begin() here unless rollback() or commit() &quot;</span>
                <span class="s2">&quot;is called first.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">begin_nested</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NestedTransaction</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Begin a nested transaction (i.e. SAVEPOINT) and return a transaction</span>
<span class="sd">        handle that controls the scope of the SAVEPOINT.</span>

<span class="sd">        E.g.::</span>

<span class="sd">            with engine.begin() as connection:</span>
<span class="sd">                with connection.begin_nested():</span>
<span class="sd">                    connection.execute(table.insert(), {&quot;username&quot;: &quot;sandy&quot;})</span>

<span class="sd">        The returned object is an instance of</span>
<span class="sd">        :class:`_engine.NestedTransaction`, which includes transactional</span>
<span class="sd">        methods :meth:`_engine.NestedTransaction.commit` and</span>
<span class="sd">        :meth:`_engine.NestedTransaction.rollback`; for a nested transaction,</span>
<span class="sd">        these methods correspond to the operations &quot;RELEASE SAVEPOINT &lt;name&gt;&quot;</span>
<span class="sd">        and &quot;ROLLBACK TO SAVEPOINT &lt;name&gt;&quot;. The name of the savepoint is local</span>
<span class="sd">        to the :class:`_engine.NestedTransaction` object and is generated</span>
<span class="sd">        automatically. Like any other :class:`_engine.Transaction`, the</span>
<span class="sd">        :class:`_engine.NestedTransaction` may be used as a context manager as</span>
<span class="sd">        illustrated above which will &quot;release&quot; or &quot;rollback&quot; corresponding to</span>
<span class="sd">        if the operation within the block were successful or raised an</span>
<span class="sd">        exception.</span>

<span class="sd">        Nested transactions require SAVEPOINT support in the underlying</span>
<span class="sd">        database, else the behavior is undefined. SAVEPOINT is commonly used to</span>
<span class="sd">        run operations within a transaction that may fail, while continuing the</span>
<span class="sd">        outer transaction. E.g.::</span>

<span class="sd">            from sqlalchemy import exc</span>

<span class="sd">            with engine.begin() as connection:</span>
<span class="sd">                trans = connection.begin_nested()</span>
<span class="sd">                try:</span>
<span class="sd">                    connection.execute(table.insert(), {&quot;username&quot;: &quot;sandy&quot;})</span>
<span class="sd">                    trans.commit()</span>
<span class="sd">                except exc.IntegrityError:  # catch for duplicate username</span>
<span class="sd">                    trans.rollback()  # rollback to savepoint</span>

<span class="sd">                # outer transaction continues</span>
<span class="sd">                connection.execute( ... )</span>

<span class="sd">        If :meth:`_engine.Connection.begin_nested` is called without first</span>
<span class="sd">        calling :meth:`_engine.Connection.begin` or</span>
<span class="sd">        :meth:`_engine.Engine.begin`, the :class:`_engine.Connection` object</span>
<span class="sd">        will &quot;autobegin&quot; the outer transaction first. This outer transaction</span>
<span class="sd">        may be committed using &quot;commit-as-you-go&quot; style, e.g.::</span>

<span class="sd">            with engine.connect() as connection:  # begin() wasn&#39;t called</span>

<span class="sd">                with connection.begin_nested(): will auto-&quot;begin()&quot; first</span>
<span class="sd">                    connection.execute( ... )</span>
<span class="sd">                # savepoint is released</span>

<span class="sd">                connection.execute( ... )</span>

<span class="sd">                # explicitly commit outer transaction</span>
<span class="sd">                connection.commit()</span>

<span class="sd">                # can continue working with connection here</span>

<span class="sd">        .. versionchanged:: 2.0</span>

<span class="sd">            :meth:`_engine.Connection.begin_nested` will now participate</span>
<span class="sd">            in the connection &quot;autobegin&quot; behavior that is new as of</span>
<span class="sd">            2.0 / &quot;future&quot; style connections in 1.4.</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            :meth:`_engine.Connection.begin`</span>

<span class="sd">            :ref:`session_begin_nested` - ORM support for SAVEPOINT</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_autobegin</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">NestedTransaction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">begin_twophase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xid</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TwoPhaseTransaction</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Begin a two-phase or XA transaction and return a transaction</span>
<span class="sd">        handle.</span>

<span class="sd">        The returned object is an instance of :class:`.TwoPhaseTransaction`,</span>
<span class="sd">        which in addition to the methods provided by</span>
<span class="sd">        :class:`.Transaction`, also provides a</span>
<span class="sd">        :meth:`~.TwoPhaseTransaction.prepare` method.</span>

<span class="sd">        :param xid: the two phase transaction id.  If not supplied, a</span>
<span class="sd">          random id will be generated.</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            :meth:`_engine.Connection.begin`</span>

<span class="sd">            :meth:`_engine.Connection.begin_twophase`</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot start a two phase transaction when a transaction &quot;</span>
                <span class="s2">&quot;is already in progress.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">xid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">create_xid</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">TwoPhaseTransaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Commit the transaction that is currently in progress.</span>

<span class="sd">        This method commits the current transaction if one has been started.</span>
<span class="sd">        If no transaction was started, the method has no effect, assuming</span>
<span class="sd">        the connection is in a non-invalidated state.</span>

<span class="sd">        A transaction is begun on a :class:`_engine.Connection` automatically</span>
<span class="sd">        whenever a statement is first executed, or when the</span>
<span class="sd">        :meth:`_engine.Connection.begin` method is called.</span>

<span class="sd">        .. note:: The :meth:`_engine.Connection.commit` method only acts upon</span>
<span class="sd">          the primary database transaction that is linked to the</span>
<span class="sd">          :class:`_engine.Connection` object.  It does not operate upon a</span>
<span class="sd">          SAVEPOINT that would have been invoked from the</span>
<span class="sd">          :meth:`_engine.Connection.begin_nested` method; for control of a</span>
<span class="sd">          SAVEPOINT, call :meth:`_engine.NestedTransaction.commit` on the</span>
<span class="sd">          :class:`_engine.NestedTransaction` that is returned by the</span>
<span class="sd">          :meth:`_engine.Connection.begin_nested` method itself.</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Roll back the transaction that is currently in progress.</span>

<span class="sd">        This method rolls back the current transaction if one has been started.</span>
<span class="sd">        If no transaction was started, the method has no effect.  If a</span>
<span class="sd">        transaction was started and the connection is in an invalidated state,</span>
<span class="sd">        the transaction is cleared using this method.</span>

<span class="sd">        A transaction is begun on a :class:`_engine.Connection` automatically</span>
<span class="sd">        whenever a statement is first executed, or when the</span>
<span class="sd">        :meth:`_engine.Connection.begin` method is called.</span>

<span class="sd">        .. note:: The :meth:`_engine.Connection.rollback` method only acts</span>
<span class="sd">          upon the primary database transaction that is linked to the</span>
<span class="sd">          :class:`_engine.Connection` object.  It does not operate upon a</span>
<span class="sd">          SAVEPOINT that would have been invoked from the</span>
<span class="sd">          :meth:`_engine.Connection.begin_nested` method; for control of a</span>
<span class="sd">          SAVEPOINT, call :meth:`_engine.NestedTransaction.rollback` on the</span>
<span class="sd">          :class:`_engine.NestedTransaction` that is returned by the</span>
<span class="sd">          :meth:`_engine.Connection.begin_nested` method itself.</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">recover_twophase</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">do_recover_twophase</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">rollback_prepared</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xid</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">recover</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">do_rollback_twophase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span> <span class="n">recover</span><span class="o">=</span><span class="n">recover</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">commit_prepared</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xid</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">recover</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">do_commit_twophase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span> <span class="n">recover</span><span class="o">=</span><span class="n">recover</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">in_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if a transaction is in progress.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="o">.</span><span class="n">is_active</span>

    <span class="k">def</span> <span class="nf">in_nested_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if a transaction is in progress.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_nested_transaction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nested_transaction</span><span class="o">.</span><span class="n">is_active</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_is_autocommit_isolation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">opt_iso</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execution_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;isolation_level&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span>
            <span class="n">opt_iso</span> <span class="o">==</span> <span class="s2">&quot;AUTOCOMMIT&quot;</span>
            <span class="ow">or</span> <span class="p">(</span>
                <span class="n">opt_iso</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">_on_connect_isolation_level</span>
                <span class="o">==</span> <span class="s2">&quot;AUTOCOMMIT&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_required_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RootTransaction</span><span class="p">:</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span>
        <span class="k">if</span> <span class="n">trans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span><span class="s2">&quot;connection is not in a transaction&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">trans</span>

    <span class="k">def</span> <span class="nf">_get_required_nested_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NestedTransaction</span><span class="p">:</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nested_transaction</span>
        <span class="k">if</span> <span class="n">trans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                <span class="s2">&quot;connection is not in a nested transaction&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">trans</span>

    <span class="k">def</span> <span class="nf">get_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RootTransaction</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the current root transaction in progress, if any.</span>

<span class="sd">        .. versionadded:: 1.4</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span>

    <span class="k">def</span> <span class="nf">get_nested_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">NestedTransaction</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the current nested transaction in progress, if any.</span>

<span class="sd">        .. versionadded:: 1.4</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nested_transaction</span>

    <span class="k">def</span> <span class="nf">_begin_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">:</span> <span class="n">RootTransaction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_echo</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_autocommit_isolation</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_info</span><span class="p">(</span>
                    <span class="s2">&quot;BEGIN (implicit; DBAPI should not BEGIN due to &quot;</span>
                    <span class="s2">&quot;autocommit mode)&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_info</span><span class="p">(</span><span class="s2">&quot;BEGIN (implicit)&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__in_begin</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_events</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_has_events</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">do_begin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_dbapi_exception</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__in_begin</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_rollback_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_events</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_has_events</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_still_open_and_dbapi_connection_is_valid</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_echo</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_autocommit_isolation</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log_info</span><span class="p">(</span>
                        <span class="s2">&quot;ROLLBACK using DBAPI connection.rollback(), &quot;</span>
                        <span class="s2">&quot;DBAPI should ignore due to autocommit mode&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log_info</span><span class="p">(</span><span class="s2">&quot;ROLLBACK&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">do_rollback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_handle_dbapi_exception</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_commit_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_events</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_has_events</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_echo</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_autocommit_isolation</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_info</span><span class="p">(</span>
                    <span class="s2">&quot;COMMIT using DBAPI connection.commit(), &quot;</span>
                    <span class="s2">&quot;DBAPI should ignore due to autocommit mode&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_info</span><span class="p">(</span><span class="s2">&quot;COMMIT&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">do_commit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_dbapi_exception</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_savepoint_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_events</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_has_events</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">savepoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__savepoint_seq</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;sa_savepoint_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__savepoint_seq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">do_savepoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">_rollback_to_savepoint_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_events</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_has_events</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">rollback_savepoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_still_open_and_dbapi_connection_is_valid</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">do_rollback_to_savepoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_release_savepoint_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_events</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_has_events</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">release_savepoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">do_release_savepoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_begin_twophase_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">:</span> <span class="n">TwoPhaseTransaction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_echo</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_info</span><span class="p">(</span><span class="s2">&quot;BEGIN TWOPHASE (implicit)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_events</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_has_events</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">begin_twophase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="o">.</span><span class="n">xid</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__in_begin</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">do_begin_twophase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="o">.</span><span class="n">xid</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_dbapi_exception</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__in_begin</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_prepare_twophase_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xid</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_events</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_has_events</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">prepare_twophase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xid</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="p">,</span> <span class="n">TwoPhaseTransaction</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">do_prepare_twophase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xid</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_dbapi_exception</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_rollback_twophase_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xid</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">is_prepared</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_events</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_has_events</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">rollback_twophase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span> <span class="n">is_prepared</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_still_open_and_dbapi_connection_is_valid</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="p">,</span> <span class="n">TwoPhaseTransaction</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">do_rollback_twophase</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span> <span class="n">is_prepared</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_handle_dbapi_exception</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_commit_twophase_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xid</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">is_prepared</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_events</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_has_events</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">commit_twophase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span> <span class="n">is_prepared</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="p">,</span> <span class="n">TwoPhaseTransaction</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">do_commit_twophase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span> <span class="n">is_prepared</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_dbapi_exception</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close this :class:`_engine.Connection`.</span>

<span class="sd">        This results in a release of the underlying database</span>
<span class="sd">        resources, that is, the DBAPI connection referenced</span>
<span class="sd">        internally. The DBAPI connection is typically restored</span>
<span class="sd">        back to the connection-holding :class:`_pool.Pool` referenced</span>
<span class="sd">        by the :class:`_engine.Engine` that produced this</span>
<span class="sd">        :class:`_engine.Connection`. Any transactional state present on</span>
<span class="sd">        the DBAPI connection is also unconditionally released via</span>
<span class="sd">        the DBAPI connection&#39;s ``rollback()`` method, regardless</span>
<span class="sd">        of any :class:`.Transaction` object that may be</span>
<span class="sd">        outstanding with regards to this :class:`_engine.Connection`.</span>

<span class="sd">        This has the effect of also calling :meth:`_engine.Connection.rollback`</span>
<span class="sd">        if any transaction is in place.</span>

<span class="sd">        After :meth:`_engine.Connection.close` is called, the</span>
<span class="sd">        :class:`_engine.Connection` is permanently in a closed state,</span>
<span class="sd">        and will allow no further operations.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">skip_reset</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">skip_reset</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbapi_connection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbapi_connection</span>

            <span class="c1"># as we just closed the transaction, close the connection</span>
            <span class="c1"># pool connection without doing an additional reset</span>
            <span class="k">if</span> <span class="n">skip_reset</span><span class="p">:</span>
                <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;_ConnectionFairy&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span><span class="o">.</span><span class="n">_close_special</span><span class="p">(</span>
                    <span class="n">transaction_reset</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c1"># There is a slight chance that conn.close() may have</span>
            <span class="c1"># triggered an invalidation here in which case</span>
            <span class="c1"># _dbapi_connection would already be None, however usually</span>
            <span class="c1"># it will be non-None here and in a &quot;closed&quot; state.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dbapi_connection</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__can_reconnect</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">scalar</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">statement</span><span class="p">:</span> <span class="n">TypedReturnsRows</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">_T</span><span class="p">]],</span>
        <span class="n">parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreSingleExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">execution_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CoreExecuteOptionsParameter</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
        <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">scalar</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">statement</span><span class="p">:</span> <span class="n">Executable</span><span class="p">,</span>
        <span class="n">parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreSingleExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">execution_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CoreExecuteOptionsParameter</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">scalar</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">statement</span><span class="p">:</span> <span class="n">Executable</span><span class="p">,</span>
        <span class="n">parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreSingleExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">execution_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CoreExecuteOptionsParameter</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Executes a SQL statement construct and returns a scalar object.</span>

<span class="sd">        This method is shorthand for invoking the</span>
<span class="sd">        :meth:`_engine.Result.scalar` method after invoking the</span>
<span class="sd">        :meth:`_engine.Connection.execute` method.  Parameters are equivalent.</span>

<span class="sd">        :return: a scalar Python value representing the first column of the</span>
<span class="sd">         first row returned.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">distilled_parameters</span> <span class="o">=</span> <span class="n">_distill_params_20</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">meth</span> <span class="o">=</span> <span class="n">statement</span><span class="o">.</span><span class="n">_execute_on_scalar</span>
        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ObjectNotExecutableError</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">meth</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">distilled_parameters</span><span class="p">,</span>
                <span class="n">execution_options</span> <span class="ow">or</span> <span class="n">NO_OPTIONS</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">scalars</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">statement</span><span class="p">:</span> <span class="n">TypedReturnsRows</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">_T</span><span class="p">]],</span>
        <span class="n">parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">execution_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CoreExecuteOptionsParameter</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ScalarResult</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
        <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">scalars</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">statement</span><span class="p">:</span> <span class="n">Executable</span><span class="p">,</span>
        <span class="n">parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">execution_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CoreExecuteOptionsParameter</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ScalarResult</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">scalars</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">statement</span><span class="p">:</span> <span class="n">Executable</span><span class="p">,</span>
        <span class="n">parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">execution_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CoreExecuteOptionsParameter</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ScalarResult</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Executes and returns a scalar result set, which yields scalar values</span>
<span class="sd">        from the first column of each row.</span>

<span class="sd">        This method is equivalent to calling :meth:`_engine.Connection.execute`</span>
<span class="sd">        to receive a :class:`_result.Result` object, then invoking the</span>
<span class="sd">        :meth:`_result.Result.scalars` method to produce a</span>
<span class="sd">        :class:`_result.ScalarResult` instance.</span>

<span class="sd">        :return: a :class:`_result.ScalarResult`</span>

<span class="sd">        .. versionadded:: 1.4.24</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">statement</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">execution_options</span><span class="o">=</span><span class="n">execution_options</span>
        <span class="p">)</span><span class="o">.</span><span class="n">scalars</span><span class="p">()</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">statement</span><span class="p">:</span> <span class="n">TypedReturnsRows</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span>
        <span class="n">parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">execution_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CoreExecuteOptionsParameter</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CursorResult</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
        <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">statement</span><span class="p">:</span> <span class="n">Executable</span><span class="p">,</span>
        <span class="n">parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">execution_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CoreExecuteOptionsParameter</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CursorResult</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">statement</span><span class="p">:</span> <span class="n">Executable</span><span class="p">,</span>
        <span class="n">parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">execution_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CoreExecuteOptionsParameter</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CursorResult</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Executes a SQL statement construct and returns a</span>
<span class="sd">        :class:`_engine.CursorResult`.</span>

<span class="sd">        :param statement: The statement to be executed.  This is always</span>
<span class="sd">         an object that is in both the :class:`_expression.ClauseElement` and</span>
<span class="sd">         :class:`_expression.Executable` hierarchies, including:</span>

<span class="sd">         * :class:`_expression.Select`</span>
<span class="sd">         * :class:`_expression.Insert`, :class:`_expression.Update`,</span>
<span class="sd">           :class:`_expression.Delete`</span>
<span class="sd">         * :class:`_expression.TextClause` and</span>
<span class="sd">           :class:`_expression.TextualSelect`</span>
<span class="sd">         * :class:`_schema.DDL` and objects which inherit from</span>
<span class="sd">           :class:`_schema.ExecutableDDLElement`</span>

<span class="sd">        :param parameters: parameters which will be bound into the statement.</span>
<span class="sd">         This may be either a dictionary of parameter names to values,</span>
<span class="sd">         or a mutable sequence (e.g. a list) of dictionaries.  When a</span>
<span class="sd">         list of dictionaries is passed, the underlying statement execution</span>
<span class="sd">         will make use of the DBAPI ``cursor.executemany()`` method.</span>
<span class="sd">         When a single dictionary is passed, the DBAPI ``cursor.execute()``</span>
<span class="sd">         method will be used.</span>

<span class="sd">        :param execution_options: optional dictionary of execution options,</span>
<span class="sd">         which will be associated with the statement execution.  This</span>
<span class="sd">         dictionary can provide a subset of the options that are accepted</span>
<span class="sd">         by :meth:`_engine.Connection.execution_options`.</span>

<span class="sd">        :return: a :class:`_engine.Result` object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">distilled_parameters</span> <span class="o">=</span> <span class="n">_distill_params_20</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">meth</span> <span class="o">=</span> <span class="n">statement</span><span class="o">.</span><span class="n">_execute_on_connection</span>
        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ObjectNotExecutableError</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">err</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">meth</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">distilled_parameters</span><span class="p">,</span>
                <span class="n">execution_options</span> <span class="ow">or</span> <span class="n">NO_OPTIONS</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_execute_function</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">func</span><span class="p">:</span> <span class="n">FunctionElement</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
        <span class="n">distilled_parameters</span><span class="p">:</span> <span class="n">_CoreMultiExecuteParams</span><span class="p">,</span>
        <span class="n">execution_options</span><span class="p">:</span> <span class="n">CoreExecuteOptionsParameter</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CursorResult</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute a sql.FunctionElement object.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_clauseelement</span><span class="p">(</span>
            <span class="n">func</span><span class="o">.</span><span class="n">select</span><span class="p">(),</span> <span class="n">distilled_parameters</span><span class="p">,</span> <span class="n">execution_options</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_execute_default</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">default</span><span class="p">:</span> <span class="n">DefaultGenerator</span><span class="p">,</span>
        <span class="n">distilled_parameters</span><span class="p">:</span> <span class="n">_CoreMultiExecuteParams</span><span class="p">,</span>
        <span class="n">execution_options</span><span class="p">:</span> <span class="n">CoreExecuteOptionsParameter</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute a schema.ColumnDefault object.&quot;&quot;&quot;</span>

        <span class="n">execution_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execution_options</span><span class="o">.</span><span class="n">merge_with</span><span class="p">(</span>
            <span class="n">execution_options</span>
        <span class="p">)</span>

        <span class="n">event_multiparams</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreMultiExecuteParams</span><span class="p">]</span>
        <span class="n">event_params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreAnyExecuteParams</span><span class="p">]</span>

        <span class="c1"># note for event handlers, the &quot;distilled parameters&quot; which is always</span>
        <span class="c1"># a list of dicts is broken out into separate &quot;multiparams&quot; and</span>
        <span class="c1"># &quot;params&quot; collections, which allows the handler to distinguish</span>
        <span class="c1"># between an executemany and execute style set of parameters.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_events</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_has_events</span><span class="p">:</span>
            <span class="p">(</span>
                <span class="n">default</span><span class="p">,</span>
                <span class="n">distilled_parameters</span><span class="p">,</span>
                <span class="n">event_multiparams</span><span class="p">,</span>
                <span class="n">event_params</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_invoke_before_exec_event</span><span class="p">(</span>
                <span class="n">default</span><span class="p">,</span> <span class="n">distilled_parameters</span><span class="p">,</span> <span class="n">execution_options</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">event_multiparams</span> <span class="o">=</span> <span class="n">event_params</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbapi_connection</span>
            <span class="k">if</span> <span class="n">conn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_revalidate_connection</span><span class="p">()</span>

            <span class="n">dialect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="n">dialect</span><span class="o">.</span><span class="n">execution_ctx_cls</span><span class="o">.</span><span class="n">_init_default</span><span class="p">(</span>
                <span class="n">dialect</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">execution_options</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">PendingRollbackError</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">ResourceClosedError</span><span class="p">):</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_dbapi_exception</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">_exec_default</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_events</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_has_events</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">after_execute</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">default</span><span class="p">,</span>
                <span class="n">event_multiparams</span><span class="p">,</span>
                <span class="n">event_params</span><span class="p">,</span>
                <span class="n">execution_options</span><span class="p">,</span>
                <span class="n">ret</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">_execute_ddl</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ddl</span><span class="p">:</span> <span class="n">ExecutableDDLElement</span><span class="p">,</span>
        <span class="n">distilled_parameters</span><span class="p">:</span> <span class="n">_CoreMultiExecuteParams</span><span class="p">,</span>
        <span class="n">execution_options</span><span class="p">:</span> <span class="n">CoreExecuteOptionsParameter</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CursorResult</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute a schema.DDL object.&quot;&quot;&quot;</span>

        <span class="n">execution_options</span> <span class="o">=</span> <span class="n">ddl</span><span class="o">.</span><span class="n">_execution_options</span><span class="o">.</span><span class="n">merge_with</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_execution_options</span><span class="p">,</span> <span class="n">execution_options</span>
        <span class="p">)</span>

        <span class="n">event_multiparams</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreMultiExecuteParams</span><span class="p">]</span>
        <span class="n">event_params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CoreSingleExecuteParams</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_events</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_has_events</span><span class="p">:</span>
            <span class="p">(</span>
                <span class="n">ddl</span><span class="p">,</span>
                <span class="n">distilled_parameters</span><span class="p">,</span>
                <span class="n">event_multiparams</span><span class="p">,</span>
                <span class="n">event_params</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_invoke_before_exec_event</span><span class="p">(</span>
                <span class="n">ddl</span><span class="p">,</span> <span class="n">distilled_parameters</span><span class="p">,</span> <span class="n">execution_options</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">event_multiparams</span> <span class="o">=</span> <span class="n">event_params</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">exec_opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execution_options</span><span class="o">.</span><span class="n">merge_with</span><span class="p">(</span><span class="n">execution_options</span><span class="p">)</span>
        <span class="n">schema_translate_map</span> <span class="o">=</span> <span class="n">exec_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;schema_translate_map&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">dialect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span>

        <span class="n">compiled</span> <span class="o">=</span> <span class="n">ddl</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
            <span class="n">dialect</span><span class="o">=</span><span class="n">dialect</span><span class="p">,</span> <span class="n">schema_translate_map</span><span class="o">=</span><span class="n">schema_translate_map</span>
        <span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_context</span><span class="p">(</span>
            <span class="n">dialect</span><span class="p">,</span>
            <span class="n">dialect</span><span class="o">.</span><span class="n">execution_ctx_cls</span><span class="o">.</span><span class="n">_init_ddl</span><span class="p">,</span>
            <span class="n">compiled</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="n">execution_options</span><span class="p">,</span>
            <span class="n">compiled</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_events</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_has_events</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">after_execute</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">ddl</span><span class="p">,</span>
                <span class="n">event_multiparams</span><span class="p">,</span>
                <span class="n">event_params</span><span class="p">,</span>
                <span class="n">execution_options</span><span class="p">,</span>
                <span class="n">ret</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">_invoke_before_exec_event</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">elem</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">distilled_params</span><span class="p">:</span> <span class="n">_CoreMultiExecuteParams</span><span class="p">,</span>
        <span class="n">execution_options</span><span class="p">:</span> <span class="n">_ExecuteOptions</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span>
        <span class="n">Any</span><span class="p">,</span>
        <span class="n">_CoreMultiExecuteParams</span><span class="p">,</span>
        <span class="n">_CoreMultiExecuteParams</span><span class="p">,</span>
        <span class="n">_CoreSingleExecuteParams</span><span class="p">,</span>
    <span class="p">]:</span>

        <span class="n">event_multiparams</span><span class="p">:</span> <span class="n">_CoreMultiExecuteParams</span>
        <span class="n">event_params</span><span class="p">:</span> <span class="n">_CoreSingleExecuteParams</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">distilled_params</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">event_multiparams</span><span class="p">,</span> <span class="n">event_params</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">distilled_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">event_multiparams</span><span class="p">,</span> <span class="n">event_params</span> <span class="o">=</span> <span class="n">distilled_params</span><span class="p">,</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">before_execute</span><span class="p">:</span>
            <span class="n">elem</span><span class="p">,</span> <span class="n">event_multiparams</span><span class="p">,</span> <span class="n">event_params</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">elem</span><span class="p">,</span>
                <span class="n">event_multiparams</span><span class="p">,</span>
                <span class="n">event_params</span><span class="p">,</span>
                <span class="n">execution_options</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">event_multiparams</span><span class="p">:</span>
            <span class="n">distilled_params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">event_multiparams</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">event_params</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                    <span class="s2">&quot;Event handler can&#39;t return non-empty multiparams &quot;</span>
                    <span class="s2">&quot;and params at the same time&quot;</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">event_params</span><span class="p">:</span>
            <span class="n">distilled_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">event_params</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">distilled_params</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">return</span> <span class="n">elem</span><span class="p">,</span> <span class="n">distilled_params</span><span class="p">,</span> <span class="n">event_multiparams</span><span class="p">,</span> <span class="n">event_params</span>

    <span class="k">def</span> <span class="nf">_execute_clauseelement</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">elem</span><span class="p">:</span> <span class="n">Executable</span><span class="p">,</span>
        <span class="n">distilled_parameters</span><span class="p">:</span> <span class="n">_CoreMultiExecuteParams</span><span class="p">,</span>
        <span class="n">execution_options</span><span class="p">:</span> <span class="n">CoreExecuteOptionsParameter</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CursorResult</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute a sql.ClauseElement object.&quot;&quot;&quot;</span>

        <span class="n">execution_options</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">_execution_options</span><span class="o">.</span><span class="n">merge_with</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_execution_options</span><span class="p">,</span> <span class="n">execution_options</span>
        <span class="p">)</span>

        <span class="n">has_events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_events</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_has_events</span>
        <span class="k">if</span> <span class="n">has_events</span><span class="p">:</span>
            <span class="p">(</span>
                <span class="n">elem</span><span class="p">,</span>
                <span class="n">distilled_parameters</span><span class="p">,</span>
                <span class="n">event_multiparams</span><span class="p">,</span>
                <span class="n">event_params</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_invoke_before_exec_event</span><span class="p">(</span>
                <span class="n">elem</span><span class="p">,</span> <span class="n">distilled_parameters</span><span class="p">,</span> <span class="n">execution_options</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">distilled_parameters</span><span class="p">:</span>
            <span class="c1"># ensure we don&#39;t retain a link to the view object for keys()</span>
            <span class="c1"># which links to the values, which we don&#39;t want to cache</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">distilled_parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">for_executemany</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">distilled_parameters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">for_executemany</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">dialect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span>

        <span class="n">schema_translate_map</span> <span class="o">=</span> <span class="n">execution_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;schema_translate_map&quot;</span><span class="p">,</span> <span class="kc">None</span>
        <span class="p">)</span>

        <span class="n">compiled_cache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CompiledCacheType</span><span class="p">]</span> <span class="o">=</span> <span class="n">execution_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;compiled_cache&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_compiled_cache</span>
        <span class="p">)</span>

        <span class="n">compiled_sql</span><span class="p">,</span> <span class="n">extracted_params</span><span class="p">,</span> <span class="n">cache_hit</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">_compile_w_cache</span><span class="p">(</span>
            <span class="n">dialect</span><span class="o">=</span><span class="n">dialect</span><span class="p">,</span>
            <span class="n">compiled_cache</span><span class="o">=</span><span class="n">compiled_cache</span><span class="p">,</span>
            <span class="n">column_keys</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span>
            <span class="n">for_executemany</span><span class="o">=</span><span class="n">for_executemany</span><span class="p">,</span>
            <span class="n">schema_translate_map</span><span class="o">=</span><span class="n">schema_translate_map</span><span class="p">,</span>
            <span class="n">linting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">compiler_linting</span> <span class="o">|</span> <span class="n">compiler</span><span class="o">.</span><span class="n">WARN_LINTING</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_context</span><span class="p">(</span>
            <span class="n">dialect</span><span class="p">,</span>
            <span class="n">dialect</span><span class="o">.</span><span class="n">execution_ctx_cls</span><span class="o">.</span><span class="n">_init_compiled</span><span class="p">,</span>
            <span class="n">compiled_sql</span><span class="p">,</span>
            <span class="n">distilled_parameters</span><span class="p">,</span>
            <span class="n">execution_options</span><span class="p">,</span>
            <span class="n">compiled_sql</span><span class="p">,</span>
            <span class="n">distilled_parameters</span><span class="p">,</span>
            <span class="n">elem</span><span class="p">,</span>
            <span class="n">extracted_params</span><span class="p">,</span>
            <span class="n">cache_hit</span><span class="o">=</span><span class="n">cache_hit</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">has_events</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">after_execute</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">elem</span><span class="p">,</span>
                <span class="n">event_multiparams</span><span class="p">,</span>
                <span class="n">event_params</span><span class="p">,</span>
                <span class="n">execution_options</span><span class="p">,</span>
                <span class="n">ret</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">_execute_compiled</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">compiled</span><span class="p">:</span> <span class="n">Compiled</span><span class="p">,</span>
        <span class="n">distilled_parameters</span><span class="p">:</span> <span class="n">_CoreMultiExecuteParams</span><span class="p">,</span>
        <span class="n">execution_options</span><span class="p">:</span> <span class="n">CoreExecuteOptionsParameter</span> <span class="o">=</span> <span class="n">_EMPTY_EXECUTION_OPTS</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CursorResult</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute a sql.Compiled object.</span>

<span class="sd">        TODO: why do we have this?   likely deprecate or remove</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">execution_options</span> <span class="o">=</span> <span class="n">compiled</span><span class="o">.</span><span class="n">execution_options</span><span class="o">.</span><span class="n">merge_with</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_execution_options</span><span class="p">,</span> <span class="n">execution_options</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_events</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_has_events</span><span class="p">:</span>
            <span class="p">(</span>
                <span class="n">compiled</span><span class="p">,</span>
                <span class="n">distilled_parameters</span><span class="p">,</span>
                <span class="n">event_multiparams</span><span class="p">,</span>
                <span class="n">event_params</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_invoke_before_exec_event</span><span class="p">(</span>
                <span class="n">compiled</span><span class="p">,</span> <span class="n">distilled_parameters</span><span class="p">,</span> <span class="n">execution_options</span>
            <span class="p">)</span>

        <span class="n">dialect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_context</span><span class="p">(</span>
            <span class="n">dialect</span><span class="p">,</span>
            <span class="n">dialect</span><span class="o">.</span><span class="n">execution_ctx_cls</span><span class="o">.</span><span class="n">_init_compiled</span><span class="p">,</span>
            <span class="n">compiled</span><span class="p">,</span>
            <span class="n">distilled_parameters</span><span class="p">,</span>
            <span class="n">execution_options</span><span class="p">,</span>
            <span class="n">compiled</span><span class="p">,</span>
            <span class="n">distilled_parameters</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_events</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_has_events</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">after_execute</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">compiled</span><span class="p">,</span>
                <span class="n">event_multiparams</span><span class="p">,</span>
                <span class="n">event_params</span><span class="p">,</span>
                <span class="n">execution_options</span><span class="p">,</span>
                <span class="n">ret</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">exec_driver_sql</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">statement</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_DBAPIAnyExecuteParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">execution_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CoreExecuteOptionsParameter</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CursorResult</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Executes a SQL statement construct and returns a</span>
<span class="sd">        :class:`_engine.CursorResult`.</span>

<span class="sd">        :param statement: The statement str to be executed.   Bound parameters</span>
<span class="sd">         must use the underlying DBAPI&#39;s paramstyle, such as &quot;qmark&quot;,</span>
<span class="sd">         &quot;pyformat&quot;, &quot;format&quot;, etc.</span>

<span class="sd">        :param parameters: represent bound parameter values to be used in the</span>
<span class="sd">         execution.  The format is one of:   a dictionary of named parameters,</span>
<span class="sd">         a tuple of positional parameters, or a list containing either</span>
<span class="sd">         dictionaries or tuples for multiple-execute support.</span>

<span class="sd">         E.g. multiple dictionaries::</span>


<span class="sd">             conn.exec_driver_sql(</span>
<span class="sd">                 &quot;INSERT INTO table (id, value) VALUES (%(id)s, %(value)s)&quot;,</span>
<span class="sd">                 [{&quot;id&quot;:1, &quot;value&quot;:&quot;v1&quot;}, {&quot;id&quot;:2, &quot;value&quot;:&quot;v2&quot;}]</span>
<span class="sd">             )</span>

<span class="sd">         Single dictionary::</span>

<span class="sd">             conn.exec_driver_sql(</span>
<span class="sd">                 &quot;INSERT INTO table (id, value) VALUES (%(id)s, %(value)s)&quot;,</span>
<span class="sd">                 dict(id=1, value=&quot;v1&quot;)</span>
<span class="sd">             )</span>

<span class="sd">         Single tuple::</span>

<span class="sd">             conn.exec_driver_sql(</span>
<span class="sd">                 &quot;INSERT INTO table (id, value) VALUES (?, ?)&quot;,</span>
<span class="sd">                 (1, &#39;v1&#39;)</span>
<span class="sd">             )</span>

<span class="sd">         .. note:: The :meth:`_engine.Connection.exec_driver_sql` method does</span>
<span class="sd">             not participate in the</span>
<span class="sd">             :meth:`_events.ConnectionEvents.before_execute` and</span>
<span class="sd">             :meth:`_events.ConnectionEvents.after_execute` events.   To</span>
<span class="sd">             intercept calls to :meth:`_engine.Connection.exec_driver_sql`, use</span>
<span class="sd">             :meth:`_events.ConnectionEvents.before_cursor_execute` and</span>
<span class="sd">             :meth:`_events.ConnectionEvents.after_cursor_execute`.</span>

<span class="sd">         .. seealso::</span>

<span class="sd">            :pep:`249`</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">distilled_parameters</span> <span class="o">=</span> <span class="n">_distill_raw_params</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>

        <span class="n">execution_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execution_options</span><span class="o">.</span><span class="n">merge_with</span><span class="p">(</span>
            <span class="n">execution_options</span>
        <span class="p">)</span>

        <span class="n">dialect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_context</span><span class="p">(</span>
            <span class="n">dialect</span><span class="p">,</span>
            <span class="n">dialect</span><span class="o">.</span><span class="n">execution_ctx_cls</span><span class="o">.</span><span class="n">_init_statement</span><span class="p">,</span>
            <span class="n">statement</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="n">execution_options</span><span class="p">,</span>
            <span class="n">statement</span><span class="p">,</span>
            <span class="n">distilled_parameters</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">_execute_context</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dialect</span><span class="p">:</span> <span class="n">Dialect</span><span class="p">,</span>
        <span class="n">constructor</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">ExecutionContext</span><span class="p">],</span>
        <span class="n">statement</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Compiled</span><span class="p">],</span>
        <span class="n">parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_AnyMultiExecuteParams</span><span class="p">],</span>
        <span class="n">execution_options</span><span class="p">:</span> <span class="n">_ExecuteOptions</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CursorResult</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create an :class:`.ExecutionContext` and execute, returning</span>
<span class="sd">        a :class:`_engine.CursorResult`.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">execution_options</span><span class="p">:</span>
            <span class="n">yp</span> <span class="o">=</span> <span class="n">execution_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;yield_per&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">yp</span><span class="p">:</span>
                <span class="n">execution_options</span> <span class="o">=</span> <span class="n">execution_options</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
                    <span class="p">{</span><span class="s2">&quot;stream_results&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;max_row_buffer&quot;</span><span class="p">:</span> <span class="n">yp</span><span class="p">}</span>
                <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbapi_connection</span>
            <span class="k">if</span> <span class="n">conn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_revalidate_connection</span><span class="p">()</span>

            <span class="n">context</span> <span class="o">=</span> <span class="n">constructor</span><span class="p">(</span>
                <span class="n">dialect</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">execution_options</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">PendingRollbackError</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">ResourceClosedError</span><span class="p">):</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_dbapi_exception</span><span class="p">(</span>
                <span class="n">e</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">statement</span><span class="p">),</span> <span class="n">parameters</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span><span class="o">.</span><span class="n">is_active</span>
            <span class="ow">or</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_nested_transaction</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nested_transaction</span><span class="o">.</span><span class="n">is_active</span>
            <span class="p">)</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_invalid_transaction</span><span class="p">()</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trans_context_manager</span><span class="p">:</span>
            <span class="n">TransactionalContext</span><span class="o">.</span><span class="n">_trans_ctx_check</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_autobegin</span><span class="p">()</span>

        <span class="n">context</span><span class="o">.</span><span class="n">pre_exec</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">execute_style</span> <span class="ow">is</span> <span class="n">ExecuteStyle</span><span class="o">.</span><span class="n">INSERTMANYVALUES</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exec_insertmany_context</span><span class="p">(</span>
                <span class="n">dialect</span><span class="p">,</span>
                <span class="n">context</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exec_single_context</span><span class="p">(</span>
                <span class="n">dialect</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">statement</span><span class="p">,</span> <span class="n">parameters</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_exec_single_context</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dialect</span><span class="p">:</span> <span class="n">Dialect</span><span class="p">,</span>
        <span class="n">context</span><span class="p">:</span> <span class="n">ExecutionContext</span><span class="p">,</span>
        <span class="n">statement</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Compiled</span><span class="p">],</span>
        <span class="n">parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_AnyMultiExecuteParams</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CursorResult</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;continue the _execute_context() method for a single DBAPI</span>
<span class="sd">        cursor.execute() or cursor.executemany() call.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dialect</span><span class="o">.</span><span class="n">bind_typing</span> <span class="ow">is</span> <span class="n">BindTyping</span><span class="o">.</span><span class="n">SETINPUTSIZES</span><span class="p">:</span>
            <span class="n">generic_setinputsizes</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">_prepare_set_input_sizes</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">generic_setinputsizes</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dialect</span><span class="o">.</span><span class="n">do_set_input_sizes</span><span class="p">(</span>
                        <span class="n">context</span><span class="o">.</span><span class="n">cursor</span><span class="p">,</span> <span class="n">generic_setinputsizes</span><span class="p">,</span> <span class="n">context</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_handle_dbapi_exception</span><span class="p">(</span>
                        <span class="n">e</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">statement</span><span class="p">),</span> <span class="n">parameters</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">context</span>
                    <span class="p">)</span>

        <span class="n">cursor</span><span class="p">,</span> <span class="n">str_statement</span><span class="p">,</span> <span class="n">parameters</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">context</span><span class="o">.</span><span class="n">cursor</span><span class="p">,</span>
            <span class="n">context</span><span class="o">.</span><span class="n">statement</span><span class="p">,</span>
            <span class="n">context</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">effective_parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_AnyExecuteParams</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">executemany</span><span class="p">:</span>
            <span class="n">effective_parameters</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">effective_parameters</span> <span class="o">=</span> <span class="n">parameters</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_events</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_has_events</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">before_cursor_execute</span><span class="p">:</span>
                <span class="n">str_statement</span><span class="p">,</span> <span class="n">effective_parameters</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="n">cursor</span><span class="p">,</span>
                    <span class="n">str_statement</span><span class="p">,</span>
                    <span class="n">effective_parameters</span><span class="p">,</span>
                    <span class="n">context</span><span class="p">,</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">executemany</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_echo</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_log_info</span><span class="p">(</span><span class="n">str_statement</span><span class="p">)</span>

            <span class="n">stats</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">_get_cache_stats</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">hide_parameters</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_info</span><span class="p">(</span>
                    <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">] </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">stats</span><span class="p">,</span>
                    <span class="n">sql_util</span><span class="o">.</span><span class="n">_repr_params</span><span class="p">(</span>
                        <span class="n">effective_parameters</span><span class="p">,</span>
                        <span class="n">batches</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">ismulti</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">executemany</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_info</span><span class="p">(</span>
                    <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">] [SQL parameters hidden due to hide_parameters=True]&quot;</span><span class="p">,</span>
                    <span class="n">stats</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="n">evt_handled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">execute_style</span> <span class="ow">is</span> <span class="n">ExecuteStyle</span><span class="o">.</span><span class="n">EXECUTEMANY</span><span class="p">:</span>
                <span class="n">effective_parameters</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
                    <span class="s2">&quot;_CoreMultiExecuteParams&quot;</span><span class="p">,</span> <span class="n">effective_parameters</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">_has_events</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">do_executemany</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">fn</span><span class="p">(</span>
                            <span class="n">cursor</span><span class="p">,</span>
                            <span class="n">str_statement</span><span class="p">,</span>
                            <span class="n">effective_parameters</span><span class="p">,</span>
                            <span class="n">context</span><span class="p">,</span>
                        <span class="p">):</span>
                            <span class="n">evt_handled</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">evt_handled</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">do_executemany</span><span class="p">(</span>
                        <span class="n">cursor</span><span class="p">,</span>
                        <span class="n">str_statement</span><span class="p">,</span>
                        <span class="n">effective_parameters</span><span class="p">,</span>
                        <span class="n">context</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">effective_parameters</span> <span class="ow">and</span> <span class="n">context</span><span class="o">.</span><span class="n">no_parameters</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">_has_events</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">do_execute_no_params</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">fn</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">str_statement</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
                            <span class="n">evt_handled</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">evt_handled</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">do_execute_no_params</span><span class="p">(</span>
                        <span class="n">cursor</span><span class="p">,</span> <span class="n">str_statement</span><span class="p">,</span> <span class="n">context</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">effective_parameters</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
                    <span class="s2">&quot;_CoreSingleExecuteParams&quot;</span><span class="p">,</span> <span class="n">effective_parameters</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">_has_events</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">do_execute</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">fn</span><span class="p">(</span>
                            <span class="n">cursor</span><span class="p">,</span>
                            <span class="n">str_statement</span><span class="p">,</span>
                            <span class="n">effective_parameters</span><span class="p">,</span>
                            <span class="n">context</span><span class="p">,</span>
                        <span class="p">):</span>
                            <span class="n">evt_handled</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">evt_handled</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">do_execute</span><span class="p">(</span>
                        <span class="n">cursor</span><span class="p">,</span> <span class="n">str_statement</span><span class="p">,</span> <span class="n">effective_parameters</span><span class="p">,</span> <span class="n">context</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_events</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_has_events</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">after_cursor_execute</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="n">cursor</span><span class="p">,</span>
                    <span class="n">str_statement</span><span class="p">,</span>
                    <span class="n">effective_parameters</span><span class="p">,</span>
                    <span class="n">context</span><span class="p">,</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">executemany</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">context</span><span class="o">.</span><span class="n">post_exec</span><span class="p">()</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">_setup_result_proxy</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_dbapi_exception</span><span class="p">(</span>
                <span class="n">e</span><span class="p">,</span> <span class="n">str_statement</span><span class="p">,</span> <span class="n">effective_parameters</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">context</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_exec_insertmany_context</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dialect</span><span class="p">:</span> <span class="n">Dialect</span><span class="p">,</span>
        <span class="n">context</span><span class="p">:</span> <span class="n">ExecutionContext</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CursorResult</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;continue the _execute_context() method for an &quot;insertmanyvalues&quot;</span>
<span class="sd">        operation, which will invoke DBAPI</span>
<span class="sd">        cursor.execute() one or more times with individual log and</span>
<span class="sd">        event hook calls.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">dialect</span><span class="o">.</span><span class="n">bind_typing</span> <span class="ow">is</span> <span class="n">BindTyping</span><span class="o">.</span><span class="n">SETINPUTSIZES</span><span class="p">:</span>
            <span class="n">generic_setinputsizes</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">_prepare_set_input_sizes</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">generic_setinputsizes</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">cursor</span><span class="p">,</span> <span class="n">str_statement</span><span class="p">,</span> <span class="n">parameters</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">context</span><span class="o">.</span><span class="n">cursor</span><span class="p">,</span>
            <span class="n">context</span><span class="o">.</span><span class="n">statement</span><span class="p">,</span>
            <span class="n">context</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">effective_parameters</span> <span class="o">=</span> <span class="n">parameters</span>

        <span class="n">engine_events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_events</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_has_events</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">_has_events</span><span class="p">:</span>
            <span class="n">do_execute_dispatch</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span>
                <span class="n">Any</span>
            <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">do_execute</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">do_execute_dispatch</span> <span class="o">=</span> <span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_echo</span><span class="p">:</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">_get_cache_stats</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; (insertmanyvalues)&quot;</span>

        <span class="k">for</span> <span class="n">imv_batch</span> <span class="ow">in</span> <span class="n">dialect</span><span class="o">.</span><span class="n">_deliver_insertmanyvalues_batches</span><span class="p">(</span>
            <span class="n">cursor</span><span class="p">,</span>
            <span class="n">str_statement</span><span class="p">,</span>
            <span class="n">effective_parameters</span><span class="p">,</span>
            <span class="n">generic_setinputsizes</span><span class="p">,</span>
            <span class="n">context</span><span class="p">,</span>
        <span class="p">):</span>

            <span class="k">if</span> <span class="n">imv_batch</span><span class="o">.</span><span class="n">processed_setinputsizes</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dialect</span><span class="o">.</span><span class="n">do_set_input_sizes</span><span class="p">(</span>
                        <span class="n">context</span><span class="o">.</span><span class="n">cursor</span><span class="p">,</span>
                        <span class="n">imv_batch</span><span class="o">.</span><span class="n">processed_setinputsizes</span><span class="p">,</span>
                        <span class="n">context</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_handle_dbapi_exception</span><span class="p">(</span>
                        <span class="n">e</span><span class="p">,</span>
                        <span class="n">sql_util</span><span class="o">.</span><span class="n">_long_statement</span><span class="p">(</span><span class="n">imv_batch</span><span class="o">.</span><span class="n">replaced_statement</span><span class="p">),</span>
                        <span class="n">imv_batch</span><span class="o">.</span><span class="n">replaced_parameters</span><span class="p">,</span>
                        <span class="kc">None</span><span class="p">,</span>
                        <span class="n">context</span><span class="p">,</span>
                    <span class="p">)</span>

            <span class="n">sub_stmt</span> <span class="o">=</span> <span class="n">imv_batch</span><span class="o">.</span><span class="n">replaced_statement</span>
            <span class="n">sub_params</span> <span class="o">=</span> <span class="n">imv_batch</span><span class="o">.</span><span class="n">replaced_parameters</span>

            <span class="k">if</span> <span class="n">engine_events</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">before_cursor_execute</span><span class="p">:</span>
                    <span class="n">sub_stmt</span><span class="p">,</span> <span class="n">sub_params</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span>
                        <span class="n">cursor</span><span class="p">,</span>
                        <span class="n">sub_stmt</span><span class="p">,</span>
                        <span class="n">sub_params</span><span class="p">,</span>
                        <span class="n">context</span><span class="p">,</span>
                        <span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_echo</span><span class="p">:</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_log_info</span><span class="p">(</span><span class="n">sql_util</span><span class="o">.</span><span class="n">_long_statement</span><span class="p">(</span><span class="n">sub_stmt</span><span class="p">))</span>

                <span class="n">imv_stats</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot; </span><span class="si">{</span>
<span class="w">                            </span><span class="n">imv_batch</span><span class="o">.</span><span class="n">batchnum</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">imv_batch</span><span class="o">.</span><span class="n">total_batches</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span>
<span class="w">                            </span><span class="s1">&#39;ordered&#39;</span>
<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="n">imv_batch</span><span class="o">.</span><span class="n">rows_sorted</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;unordered&#39;</span>
<span class="w">                        </span><span class="si">}{</span>
<span class="w">                            </span><span class="s1">&#39;; batch not supported&#39;</span>
<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="n">imv_batch</span><span class="o">.</span><span class="n">is_downgraded</span>
<span class="w">                            </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span>
<span class="w">                        </span><span class="si">}</span><span class="s2">)&quot;&quot;&quot;</span>

                <span class="k">if</span> <span class="n">imv_batch</span><span class="o">.</span><span class="n">batchnum</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">stats</span> <span class="o">+=</span> <span class="n">imv_stats</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">stats</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;insertmanyvalues</span><span class="si">{</span><span class="n">imv_stats</span><span class="si">}</span><span class="s2">&quot;</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">hide_parameters</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log_info</span><span class="p">(</span>
                        <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">] </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">stats</span><span class="p">,</span>
                        <span class="n">sql_util</span><span class="o">.</span><span class="n">_repr_params</span><span class="p">(</span>
                            <span class="n">sub_params</span><span class="p">,</span>
                            <span class="n">batches</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                            <span class="n">ismulti</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log_info</span><span class="p">(</span>
                        <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">] [SQL parameters hidden due to &quot;</span>
                        <span class="s2">&quot;hide_parameters=True]&quot;</span><span class="p">,</span>
                        <span class="n">stats</span><span class="p">,</span>
                    <span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">do_execute_dispatch</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">fn</span><span class="p">(</span>
                        <span class="n">cursor</span><span class="p">,</span>
                        <span class="n">sub_stmt</span><span class="p">,</span>
                        <span class="n">sub_params</span><span class="p">,</span>
                        <span class="n">context</span><span class="p">,</span>
                    <span class="p">):</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dialect</span><span class="o">.</span><span class="n">do_execute</span><span class="p">(</span>
                        <span class="n">cursor</span><span class="p">,</span>
                        <span class="n">sub_stmt</span><span class="p">,</span>
                        <span class="n">sub_params</span><span class="p">,</span>
                        <span class="n">context</span><span class="p">,</span>
                    <span class="p">)</span>

            <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_handle_dbapi_exception</span><span class="p">(</span>
                    <span class="n">e</span><span class="p">,</span>
                    <span class="n">sql_util</span><span class="o">.</span><span class="n">_long_statement</span><span class="p">(</span><span class="n">sub_stmt</span><span class="p">),</span>
                    <span class="n">sub_params</span><span class="p">,</span>
                    <span class="n">cursor</span><span class="p">,</span>
                    <span class="n">context</span><span class="p">,</span>
                    <span class="n">is_sub_exec</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">engine_events</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">after_cursor_execute</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="n">cursor</span><span class="p">,</span>
                    <span class="n">str_statement</span><span class="p">,</span>
                    <span class="n">effective_parameters</span><span class="p">,</span>
                    <span class="n">context</span><span class="p">,</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">executemany</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">post_exec</span><span class="p">()</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">_setup_result_proxy</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_dbapi_exception</span><span class="p">(</span>
                <span class="n">e</span><span class="p">,</span> <span class="n">str_statement</span><span class="p">,</span> <span class="n">effective_parameters</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">context</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_cursor_execute</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cursor</span><span class="p">:</span> <span class="n">DBAPICursor</span><span class="p">,</span>
        <span class="n">statement</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">parameters</span><span class="p">:</span> <span class="n">_DBAPISingleExecuteParams</span><span class="p">,</span>
        <span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ExecutionContext</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute a statement + params on the given cursor.</span>

<span class="sd">        Adds appropriate logging and exception handling.</span>

<span class="sd">        This method is used by DefaultDialect for special-case</span>
<span class="sd">        executions, such as for sequences and column defaults.</span>
<span class="sd">        The path of statement execution in the majority of cases</span>
<span class="sd">        terminates at _execute_context().</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_events</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_has_events</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">before_cursor_execute</span><span class="p">:</span>
                <span class="n">statement</span><span class="p">,</span> <span class="n">parameters</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">statement</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="kc">False</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_echo</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_info</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_info</span><span class="p">(</span><span class="s2">&quot;[raw sql] </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">_has_events</span>
                <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">do_execute</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="n">fn</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">statement</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">do_execute</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">statement</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_dbapi_exception</span><span class="p">(</span>
                <span class="n">e</span><span class="p">,</span> <span class="n">statement</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">context</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_events</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">_has_events</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">after_cursor_execute</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">statement</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="kc">False</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_safe_close_cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cursor</span><span class="p">:</span> <span class="n">DBAPICursor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close the given cursor, catching exceptions</span>
<span class="sd">        and turning into log warnings.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># log the error through the connection pool&#39;s logger.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Error closing cursor&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

    <span class="n">_reentrant_error</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_is_disconnect</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_handle_dbapi_exception</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">e</span><span class="p">:</span> <span class="ne">BaseException</span><span class="p">,</span>
        <span class="n">statement</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_AnyExecuteParams</span><span class="p">],</span>
        <span class="n">cursor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DBAPICursor</span><span class="p">],</span>
        <span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ExecutionContext</span><span class="p">],</span>
        <span class="n">is_sub_exec</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
        <span class="n">exc_info</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>

        <span class="n">is_exit_exception</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">is_exit_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_disconnect</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_disconnect</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">loaded_dbapi</span><span class="o">.</span><span class="n">Error</span><span class="p">)</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">is_disconnect</span><span class="p">(</span>
                    <span class="n">e</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_dbapi_connection</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">invalidated</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">cursor</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">is_exit_exception</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span>

        <span class="n">invalidate_pool_on_disconnect</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">is_exit_exception</span>

        <span class="n">ismulti</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">is_sub_exec</span> <span class="ow">and</span> <span class="n">context</span><span class="o">.</span><span class="n">executemany</span>
            <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="kc">False</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reentrant_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">DBAPIError</span><span class="o">.</span><span class="n">instance</span><span class="p">(</span>
                <span class="n">statement</span><span class="p">,</span>
                <span class="n">parameters</span><span class="p">,</span>
                <span class="n">e</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">loaded_dbapi</span><span class="o">.</span><span class="n">Error</span><span class="p">,</span>
                <span class="n">hide_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">hide_parameters</span><span class="p">,</span>
                <span class="n">dialect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="p">,</span>
                <span class="n">ismulti</span><span class="o">=</span><span class="n">ismulti</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reentrant_error</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># non-DBAPI error - if we already got a context,</span>
            <span class="c1"># or there&#39;s no string statement, don&#39;t wrap it</span>
            <span class="n">should_wrap</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">loaded_dbapi</span><span class="o">.</span><span class="n">Error</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="n">statement</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="n">context</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_exit_exception</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">should_wrap</span><span class="p">:</span>
                <span class="n">sqlalchemy_exception</span> <span class="o">=</span> <span class="n">exc</span><span class="o">.</span><span class="n">DBAPIError</span><span class="o">.</span><span class="n">instance</span><span class="p">(</span>
                    <span class="n">statement</span><span class="p">,</span>
                    <span class="n">parameters</span><span class="p">,</span>
                    <span class="n">cast</span><span class="p">(</span><span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">loaded_dbapi</span><span class="o">.</span><span class="n">Error</span><span class="p">,</span>
                    <span class="n">hide_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">hide_parameters</span><span class="p">,</span>
                    <span class="n">connection_invalidated</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_disconnect</span><span class="p">,</span>
                    <span class="n">dialect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="p">,</span>
                    <span class="n">ismulti</span><span class="o">=</span><span class="n">ismulti</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sqlalchemy_exception</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">newraise</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">_has_events</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execution_options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;skip_user_error_events&quot;</span><span class="p">,</span> <span class="kc">False</span>
            <span class="p">):</span>
                <span class="n">ctx</span> <span class="o">=</span> <span class="n">ExceptionContextImpl</span><span class="p">(</span>
                    <span class="n">e</span><span class="p">,</span>
                    <span class="n">sqlalchemy_exception</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="p">,</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="n">cursor</span><span class="p">,</span>
                    <span class="n">statement</span><span class="p">,</span>
                    <span class="n">parameters</span><span class="p">,</span>
                    <span class="n">context</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_is_disconnect</span><span class="p">,</span>
                    <span class="n">invalidate_pool_on_disconnect</span><span class="p">,</span>
                    <span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">handle_error</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># handler returns an exception;</span>
                        <span class="c1"># call next handler in a chain</span>
                        <span class="n">per_fn</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">per_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">ctx</span><span class="o">.</span><span class="n">chained_exception</span> <span class="o">=</span> <span class="n">newraise</span> <span class="o">=</span> <span class="n">per_fn</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">_raised</span><span class="p">:</span>
                        <span class="c1"># handler raises an exception - stop processing</span>
                        <span class="n">newraise</span> <span class="o">=</span> <span class="n">_raised</span>
                        <span class="k">break</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_disconnect</span> <span class="o">!=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">is_disconnect</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_is_disconnect</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">is_disconnect</span>
                    <span class="k">if</span> <span class="n">sqlalchemy_exception</span><span class="p">:</span>
                        <span class="n">sqlalchemy_exception</span><span class="o">.</span><span class="n">connection_invalidated</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">ctx</span><span class="o">.</span><span class="n">is_disconnect</span>
                        <span class="p">)</span>

                <span class="c1"># set up potentially user-defined value for</span>
                <span class="c1"># invalidate pool.</span>
                <span class="n">invalidate_pool_on_disconnect</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="n">invalidate_pool_on_disconnect</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">should_wrap</span> <span class="ow">and</span> <span class="n">context</span><span class="p">:</span>
                <span class="n">context</span><span class="o">.</span><span class="n">handle_dbapi_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_disconnect</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cursor</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_safe_close_cursor</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
                <span class="c1"># &quot;autorollback&quot; was mostly relevant in 1.x series.</span>
                <span class="c1"># It&#39;s very unlikely to reach here, as the connection</span>
                <span class="c1"># does autobegin so when we are here, we are usually</span>
                <span class="c1"># in an explicit / semi-explicit transaction.</span>
                <span class="c1"># however we have a test which manufactures this</span>
                <span class="c1"># scenario in any case using an event handler.</span>
                <span class="c1"># test/engine/test_execute.py-&gt; test_actual_autorollback</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_transaction</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_rollback_impl</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">newraise</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">newraise</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="kn">from</span> <span class="nn">e</span>
            <span class="k">elif</span> <span class="n">should_wrap</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">sqlalchemy_exception</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">raise</span> <span class="n">sqlalchemy_exception</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="kn">from</span> <span class="nn">e</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">exc_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">raise</span> <span class="n">exc_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reentrant_error</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_disconnect</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_disconnect</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">invalidated</span><span class="p">:</span>
                    <span class="n">dbapi_conn_wrapper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbapi_connection</span>
                    <span class="k">assert</span> <span class="n">dbapi_conn_wrapper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">invalidate_pool_on_disconnect</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">_invalidate</span><span class="p">(</span><span class="n">dbapi_conn_wrapper</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_handle_dbapi_exception_noconnection</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">e</span><span class="p">:</span> <span class="ne">BaseException</span><span class="p">,</span>
        <span class="n">dialect</span><span class="p">:</span> <span class="n">Dialect</span><span class="p">,</span>
        <span class="n">engine</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Engine</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">is_disconnect</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">invalidate_pool_on_disconnect</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">is_pre_ping</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
        <span class="n">exc_info</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">is_disconnect</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">is_disconnect</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">e</span><span class="p">,</span> <span class="n">dialect</span><span class="o">.</span><span class="n">loaded_dbapi</span><span class="o">.</span><span class="n">Error</span>
            <span class="p">)</span> <span class="ow">and</span> <span class="n">dialect</span><span class="o">.</span><span class="n">is_disconnect</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">should_wrap</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">dialect</span><span class="o">.</span><span class="n">loaded_dbapi</span><span class="o">.</span><span class="n">Error</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">should_wrap</span><span class="p">:</span>
            <span class="n">sqlalchemy_exception</span> <span class="o">=</span> <span class="n">exc</span><span class="o">.</span><span class="n">DBAPIError</span><span class="o">.</span><span class="n">instance</span><span class="p">(</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="n">cast</span><span class="p">(</span><span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">),</span>
                <span class="n">dialect</span><span class="o">.</span><span class="n">loaded_dbapi</span><span class="o">.</span><span class="n">Error</span><span class="p">,</span>
                <span class="n">hide_parameters</span><span class="o">=</span><span class="n">engine</span><span class="o">.</span><span class="n">hide_parameters</span>
                <span class="k">if</span> <span class="n">engine</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">connection_invalidated</span><span class="o">=</span><span class="n">is_disconnect</span><span class="p">,</span>
                <span class="n">dialect</span><span class="o">=</span><span class="n">dialect</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sqlalchemy_exception</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">newraise</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">dialect</span><span class="o">.</span><span class="n">_has_events</span><span class="p">:</span>
            <span class="n">ctx</span> <span class="o">=</span> <span class="n">ExceptionContextImpl</span><span class="p">(</span>
                <span class="n">e</span><span class="p">,</span>
                <span class="n">sqlalchemy_exception</span><span class="p">,</span>
                <span class="n">engine</span><span class="p">,</span>
                <span class="n">dialect</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="n">is_disconnect</span><span class="p">,</span>
                <span class="n">invalidate_pool_on_disconnect</span><span class="p">,</span>
                <span class="n">is_pre_ping</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">dialect</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">handle_error</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># handler returns an exception;</span>
                    <span class="c1"># call next handler in a chain</span>
                    <span class="n">per_fn</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">per_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">ctx</span><span class="o">.</span><span class="n">chained_exception</span> <span class="o">=</span> <span class="n">newraise</span> <span class="o">=</span> <span class="n">per_fn</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">_raised</span><span class="p">:</span>
                    <span class="c1"># handler raises an exception - stop processing</span>
                    <span class="n">newraise</span> <span class="o">=</span> <span class="n">_raised</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">sqlalchemy_exception</span> <span class="ow">and</span> <span class="n">is_disconnect</span> <span class="o">!=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">is_disconnect</span><span class="p">:</span>
                <span class="n">sqlalchemy_exception</span><span class="o">.</span><span class="n">connection_invalidated</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">is_disconnect</span>
                <span class="p">)</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">is_disconnect</span>

        <span class="k">if</span> <span class="n">newraise</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">newraise</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="k">elif</span> <span class="n">should_wrap</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">sqlalchemy_exception</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">raise</span> <span class="n">sqlalchemy_exception</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">exc_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">raise</span> <span class="n">exc_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">exc_info</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_run_ddl_visitor</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">visitorcallable</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">SchemaGenerator</span><span class="p">,</span> <span class="n">SchemaDropper</span><span class="p">]],</span>
        <span class="n">element</span><span class="p">:</span> <span class="n">SchemaItem</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;run a DDL visitor.</span>

<span class="sd">        This method is only here so that the MockConnection can change the</span>
<span class="sd">        options given to the visitor so that &quot;checkfirst&quot; is skipped.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">visitorcallable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">traverse_single</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ExceptionContextImpl</span><span class="p">(</span><span class="n">ExceptionContext</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Implement the :class:`.ExceptionContext` interface.&quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;connection&quot;</span><span class="p">,</span>
        <span class="s2">&quot;engine&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dialect&quot;</span><span class="p">,</span>
        <span class="s2">&quot;cursor&quot;</span><span class="p">,</span>
        <span class="s2">&quot;statement&quot;</span><span class="p">,</span>
        <span class="s2">&quot;parameters&quot;</span><span class="p">,</span>
        <span class="s2">&quot;original_exception&quot;</span><span class="p">,</span>
        <span class="s2">&quot;sqlalchemy_exception&quot;</span><span class="p">,</span>
        <span class="s2">&quot;chained_exception&quot;</span><span class="p">,</span>
        <span class="s2">&quot;execution_context&quot;</span><span class="p">,</span>
        <span class="s2">&quot;is_disconnect&quot;</span><span class="p">,</span>
        <span class="s2">&quot;invalidate_pool_on_disconnect&quot;</span><span class="p">,</span>
        <span class="s2">&quot;is_pre_ping&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">exception</span><span class="p">:</span> <span class="ne">BaseException</span><span class="p">,</span>
        <span class="n">sqlalchemy_exception</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">exc</span><span class="o">.</span><span class="n">StatementError</span><span class="p">],</span>
        <span class="n">engine</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Engine</span><span class="p">],</span>
        <span class="n">dialect</span><span class="p">:</span> <span class="n">Dialect</span><span class="p">,</span>
        <span class="n">connection</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Connection</span><span class="p">],</span>
        <span class="n">cursor</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DBAPICursor</span><span class="p">],</span>
        <span class="n">statement</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_DBAPIAnyExecuteParams</span><span class="p">],</span>
        <span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ExecutionContext</span><span class="p">],</span>
        <span class="n">is_disconnect</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">invalidate_pool_on_disconnect</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">is_pre_ping</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="n">engine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span> <span class="o">=</span> <span class="n">dialect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sqlalchemy_exception</span> <span class="o">=</span> <span class="n">sqlalchemy_exception</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_exception</span> <span class="o">=</span> <span class="n">exception</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execution_context</span> <span class="o">=</span> <span class="n">context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statement</span> <span class="o">=</span> <span class="n">statement</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_disconnect</span> <span class="o">=</span> <span class="n">is_disconnect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">invalidate_pool_on_disconnect</span> <span class="o">=</span> <span class="n">invalidate_pool_on_disconnect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_pre_ping</span> <span class="o">=</span> <span class="n">is_pre_ping</span>


<span class="k">class</span> <span class="nc">Transaction</span><span class="p">(</span><span class="n">TransactionalContext</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represent a database transaction in progress.</span>

<span class="sd">    The :class:`.Transaction` object is procured by</span>
<span class="sd">    calling the :meth:`_engine.Connection.begin` method of</span>
<span class="sd">    :class:`_engine.Connection`::</span>

<span class="sd">        from sqlalchemy import create_engine</span>
<span class="sd">        engine = create_engine(&quot;postgresql+psycopg2://scott:tiger@localhost/test&quot;)</span>
<span class="sd">        connection = engine.connect()</span>
<span class="sd">        trans = connection.begin()</span>
<span class="sd">        connection.execute(text(&quot;insert into x (a, b) values (1, 2)&quot;))</span>
<span class="sd">        trans.commit()</span>

<span class="sd">    The object provides :meth:`.rollback` and :meth:`.commit`</span>
<span class="sd">    methods in order to control transaction boundaries.  It</span>
<span class="sd">    also implements a context manager interface so that</span>
<span class="sd">    the Python ``with`` statement can be used with the</span>
<span class="sd">    :meth:`_engine.Connection.begin` method::</span>

<span class="sd">        with connection.begin():</span>
<span class="sd">            connection.execute(text(&quot;insert into x (a, b) values (1, 2)&quot;))</span>

<span class="sd">    The Transaction object is **not** threadsafe.</span>

<span class="sd">    .. seealso::</span>

<span class="sd">        :meth:`_engine.Connection.begin`</span>

<span class="sd">        :meth:`_engine.Connection.begin_twophase`</span>

<span class="sd">        :meth:`_engine.Connection.begin_nested`</span>

<span class="sd">    .. index::</span>
<span class="sd">      single: thread safety; Transaction</span>
<span class="sd">    &quot;&quot;&quot;</span>  <span class="c1"># noqa</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

    <span class="n">_is_root</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">is_active</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">connection</span><span class="p">:</span> <span class="n">Connection</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="n">Connection</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_deactivated_from_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;True if this transaction is totally deactivated from the connection</span>
<span class="sd">        and therefore can no longer affect its state.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_do_close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_do_rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_do_commit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">invalidated</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close this :class:`.Transaction`.</span>

<span class="sd">        If this transaction is the base transaction in a begin/commit</span>
<span class="sd">        nesting, the transaction will rollback().  Otherwise, the</span>
<span class="sd">        method returns.</span>

<span class="sd">        This is used to cancel a Transaction without affecting the scope of</span>
<span class="sd">        an enclosing transaction.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_do_close</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span>

    <span class="k">def</span> <span class="nf">rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Roll back this :class:`.Transaction`.</span>

<span class="sd">        The implementation of this may vary based on the type of transaction in</span>
<span class="sd">        use:</span>

<span class="sd">        * For a simple database transaction (e.g. :class:`.RootTransaction`),</span>
<span class="sd">          it corresponds to a ROLLBACK.</span>

<span class="sd">        * For a :class:`.NestedTransaction`, it corresponds to a</span>
<span class="sd">          &quot;ROLLBACK TO SAVEPOINT&quot; operation.</span>

<span class="sd">        * For a :class:`.TwoPhaseTransaction`, DBAPI-specific methods for two</span>
<span class="sd">          phase transactions may be used.</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_do_rollback</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span>

    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Commit this :class:`.Transaction`.</span>

<span class="sd">        The implementation of this may vary based on the type of transaction in</span>
<span class="sd">        use:</span>

<span class="sd">        * For a simple database transaction (e.g. :class:`.RootTransaction`),</span>
<span class="sd">          it corresponds to a COMMIT.</span>

<span class="sd">        * For a :class:`.NestedTransaction`, it corresponds to a</span>
<span class="sd">          &quot;RELEASE SAVEPOINT&quot; operation.</span>

<span class="sd">        * For a :class:`.TwoPhaseTransaction`, DBAPI-specific methods for two</span>
<span class="sd">          phase transactions may be used.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_do_commit</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span>

    <span class="k">def</span> <span class="nf">_get_subject</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Connection</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span>

    <span class="k">def</span> <span class="nf">_transaction_is_active</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span>

    <span class="k">def</span> <span class="nf">_transaction_is_closed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deactivated_from_connection</span>

    <span class="k">def</span> <span class="nf">_rollback_can_be_called</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="c1"># for RootTransaction / NestedTransaction, it&#39;s safe to call</span>
        <span class="c1"># rollback() even if the transaction is deactive and no warnings</span>
        <span class="c1"># will be emitted.  tested in</span>
        <span class="c1"># test_transaction.py -&gt; test_no_rollback_in_deactive(?:_savepoint)?</span>
        <span class="k">return</span> <span class="kc">True</span>


<span class="k">class</span> <span class="nc">RootTransaction</span><span class="p">(</span><span class="n">Transaction</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represent the &quot;root&quot; transaction on a :class:`_engine.Connection`.</span>

<span class="sd">    This corresponds to the current &quot;BEGIN/COMMIT/ROLLBACK&quot; that&#39;s occurring</span>
<span class="sd">    for the :class:`_engine.Connection`. The :class:`_engine.RootTransaction`</span>
<span class="sd">    is created by calling upon the :meth:`_engine.Connection.begin` method, and</span>
<span class="sd">    remains associated with the :class:`_engine.Connection` throughout its</span>
<span class="sd">    active span. The current :class:`_engine.RootTransaction` in use is</span>
<span class="sd">    accessible via the :attr:`_engine.Connection.get_transaction` method of</span>
<span class="sd">    :class:`_engine.Connection`.</span>

<span class="sd">    In :term:`2.0 style` use, the :class:`_engine.Connection` also employs</span>
<span class="sd">    &quot;autobegin&quot; behavior that will create a new</span>
<span class="sd">    :class:`_engine.RootTransaction` whenever a connection in a</span>
<span class="sd">    non-transactional state is used to emit commands on the DBAPI connection.</span>
<span class="sd">    The scope of the :class:`_engine.RootTransaction` in 2.0 style</span>
<span class="sd">    use can be controlled using the :meth:`_engine.Connection.commit` and</span>
<span class="sd">    :meth:`_engine.Connection.rollback` methods.</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_is_root</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;connection&quot;</span><span class="p">,</span> <span class="s2">&quot;is_active&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="n">Connection</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">connection</span><span class="o">.</span><span class="n">_transaction</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">_trans_context_manager</span><span class="p">:</span>
            <span class="n">TransactionalContext</span><span class="o">.</span><span class="n">_trans_ctx_check</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connection_begin_impl</span><span class="p">()</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">_transaction</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_deactivate_from_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">_transaction</span> <span class="ow">is</span> <span class="bp">self</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">_transaction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;transaction already deassociated from connection&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_deactivated_from_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">_transaction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">_connection_begin_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">_begin_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_connection_rollback_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">_rollback_impl</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_connection_commit_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">_commit_impl</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_close_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">try_deactivate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_connection_rollback_impl</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">_nested_transaction</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">_nested_transaction</span><span class="o">.</span><span class="n">_cancel</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span> <span class="ow">or</span> <span class="n">try_deactivate</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_deactivate_from_connection</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">_transaction</span> <span class="ow">is</span> <span class="bp">self</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">_transaction</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">_transaction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">_do_close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_close_impl</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_do_rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_close_impl</span><span class="p">(</span><span class="n">try_deactivate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_do_commit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">_transaction</span> <span class="ow">is</span> <span class="bp">self</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_connection_commit_impl</span><span class="p">()</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="c1"># whether or not commit succeeds, cancel any</span>
                <span class="c1"># nested transactions, make this transaction &quot;inactive&quot;</span>
                <span class="c1"># and remove it as a reset agent</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">_nested_transaction</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">_nested_transaction</span><span class="o">.</span><span class="n">_cancel</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_deactivate_from_connection</span><span class="p">()</span>

            <span class="c1"># ...however only remove as the connection&#39;s current transaction</span>
            <span class="c1"># if commit succeeded.  otherwise it stays on so that a rollback</span>
            <span class="c1"># needs to occur.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">_transaction</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">_transaction</span> <span class="ow">is</span> <span class="bp">self</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">_invalid_transaction</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span><span class="s2">&quot;This transaction is inactive&quot;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">_transaction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span>


<span class="k">class</span> <span class="nc">NestedTransaction</span><span class="p">(</span><span class="n">Transaction</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represent a &#39;nested&#39;, or SAVEPOINT transaction.</span>

<span class="sd">    The :class:`.NestedTransaction` object is created by calling the</span>
<span class="sd">    :meth:`_engine.Connection.begin_nested` method of</span>
<span class="sd">    :class:`_engine.Connection`.</span>

<span class="sd">    When using :class:`.NestedTransaction`, the semantics of &quot;begin&quot; /</span>
<span class="sd">    &quot;commit&quot; / &quot;rollback&quot; are as follows:</span>

<span class="sd">    * the &quot;begin&quot; operation corresponds to the &quot;BEGIN SAVEPOINT&quot; command, where</span>
<span class="sd">      the savepoint is given an explicit name that is part of the state</span>
<span class="sd">      of this object.</span>

<span class="sd">    * The :meth:`.NestedTransaction.commit` method corresponds to a</span>
<span class="sd">      &quot;RELEASE SAVEPOINT&quot; operation, using the savepoint identifier associated</span>
<span class="sd">      with this :class:`.NestedTransaction`.</span>

<span class="sd">    * The :meth:`.NestedTransaction.rollback` method corresponds to a</span>
<span class="sd">      &quot;ROLLBACK TO SAVEPOINT&quot; operation, using the savepoint identifier</span>
<span class="sd">      associated with this :class:`.NestedTransaction`.</span>

<span class="sd">    The rationale for mimicking the semantics of an outer transaction in</span>
<span class="sd">    terms of savepoints so that code may deal with a &quot;savepoint&quot; transaction</span>
<span class="sd">    and an &quot;outer&quot; transaction in an agnostic way.</span>

<span class="sd">    .. seealso::</span>

<span class="sd">        :ref:`session_begin_nested` - ORM version of the SAVEPOINT API.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;connection&quot;</span><span class="p">,</span> <span class="s2">&quot;is_active&quot;</span><span class="p">,</span> <span class="s2">&quot;_savepoint&quot;</span><span class="p">,</span> <span class="s2">&quot;_previous_nested&quot;</span><span class="p">)</span>

    <span class="n">_savepoint</span><span class="p">:</span> <span class="nb">str</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="n">Connection</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">connection</span><span class="o">.</span><span class="n">_transaction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">_trans_context_manager</span><span class="p">:</span>
            <span class="n">TransactionalContext</span><span class="o">.</span><span class="n">_trans_ctx_check</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_savepoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">_savepoint_impl</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_previous_nested</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">_nested_transaction</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">_nested_transaction</span> <span class="o">=</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">_deactivate_from_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">warn</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">_nested_transaction</span> <span class="ow">is</span> <span class="bp">self</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">_nested_transaction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_previous_nested</span>
        <span class="k">elif</span> <span class="n">warn</span><span class="p">:</span>
            <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;nested transaction already deassociated from connection&quot;</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_deactivated_from_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">_nested_transaction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">_cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># called by RootTransaction when the outer transaction is</span>
        <span class="c1"># committed, rolled back, or closed to cancel all savepoints</span>
        <span class="c1"># without any action being taken</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_deactivate_from_connection</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_previous_nested</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_previous_nested</span><span class="o">.</span><span class="n">_cancel</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_close_impl</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">deactivate_from_connection</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">warn_already_deactive</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">_transaction</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">_transaction</span><span class="o">.</span><span class="n">is_active</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">_rollback_to_savepoint_impl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_savepoint</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">deactivate_from_connection</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_deactivate_from_connection</span><span class="p">(</span><span class="n">warn</span><span class="o">=</span><span class="n">warn_already_deactive</span><span class="p">)</span>

        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span>
        <span class="k">if</span> <span class="n">deactivate_from_connection</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">_nested_transaction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">_do_close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_close_impl</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_do_rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_close_impl</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_do_commit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">_release_savepoint_impl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_savepoint</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="c1"># nested trans becomes inactive on failed release</span>
                <span class="c1"># unconditionally.  this prevents it from trying to</span>
                <span class="c1"># emit SQL when it rolls back.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># but only de-associate from connection if it succeeded</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_deactivate_from_connection</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">_nested_transaction</span> <span class="ow">is</span> <span class="bp">self</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">_invalid_transaction</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                    <span class="s2">&quot;This nested transaction is inactive&quot;</span>
                <span class="p">)</span>


<span class="k">class</span> <span class="nc">TwoPhaseTransaction</span><span class="p">(</span><span class="n">RootTransaction</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represent a two-phase transaction.</span>

<span class="sd">    A new :class:`.TwoPhaseTransaction` object may be procured</span>
<span class="sd">    using the :meth:`_engine.Connection.begin_twophase` method.</span>

<span class="sd">    The interface is the same as that of :class:`.Transaction`</span>
<span class="sd">    with the addition of the :meth:`prepare` method.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;xid&quot;</span><span class="p">,</span> <span class="s2">&quot;_is_prepared&quot;</span><span class="p">)</span>

    <span class="n">xid</span><span class="p">:</span> <span class="n">Any</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="n">Connection</span><span class="p">,</span> <span class="n">xid</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_prepared</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xid</span> <span class="o">=</span> <span class="n">xid</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare this :class:`.TwoPhaseTransaction`.</span>

<span class="sd">        After a PREPARE, the transaction can be committed.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span><span class="s2">&quot;This transaction is inactive&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">_prepare_twophase_impl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_prepared</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_connection_begin_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">_begin_twophase_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_connection_rollback_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">_rollback_twophase_impl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_prepared</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_connection_commit_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">_commit_twophase_impl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_prepared</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Engine</span><span class="p">(</span>
    <span class="n">ConnectionEventsTarget</span><span class="p">,</span> <span class="n">log</span><span class="o">.</span><span class="n">Identified</span><span class="p">,</span> <span class="n">inspection</span><span class="o">.</span><span class="n">Inspectable</span><span class="p">[</span><span class="s2">&quot;Inspector&quot;</span><span class="p">]</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Connects a :class:`~sqlalchemy.pool.Pool` and</span>
<span class="sd">    :class:`~sqlalchemy.engine.interfaces.Dialect` together to provide a</span>
<span class="sd">    source of database connectivity and behavior.</span>

<span class="sd">    An :class:`_engine.Engine` object is instantiated publicly using the</span>
<span class="sd">    :func:`~sqlalchemy.create_engine` function.</span>

<span class="sd">    .. seealso::</span>

<span class="sd">        :doc:`/core/engines`</span>

<span class="sd">        :ref:`connections_toplevel`</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dispatch</span><span class="p">:</span> <span class="n">dispatcher</span><span class="p">[</span><span class="n">ConnectionEventsTarget</span><span class="p">]</span>

    <span class="n">_compiled_cache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CompiledCacheType</span><span class="p">]</span>

    <span class="n">_execution_options</span><span class="p">:</span> <span class="n">_ExecuteOptions</span> <span class="o">=</span> <span class="n">_EMPTY_EXECUTION_OPTS</span>
    <span class="n">_has_events</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_connection_cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Connection</span><span class="p">]</span> <span class="o">=</span> <span class="n">Connection</span>
    <span class="n">_sqla_logger_namespace</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;sqlalchemy.engine.Engine&quot;</span>
    <span class="n">_is_future</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">_schema_translate_map</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SchemaTranslateMapType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_option_cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">OptionEngine</span><span class="p">]</span>

    <span class="n">dialect</span><span class="p">:</span> <span class="n">Dialect</span>
    <span class="n">pool</span><span class="p">:</span> <span class="n">Pool</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">URL</span>
    <span class="n">hide_parameters</span><span class="p">:</span> <span class="nb">bool</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pool</span><span class="p">:</span> <span class="n">Pool</span><span class="p">,</span>
        <span class="n">dialect</span><span class="p">:</span> <span class="n">Dialect</span><span class="p">,</span>
        <span class="n">url</span><span class="p">:</span> <span class="n">URL</span><span class="p">,</span>
        <span class="n">logging_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">echo</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_EchoFlagType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">query_cache_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span>
        <span class="n">execution_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">hide_parameters</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">pool</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span> <span class="o">=</span> <span class="n">dialect</span>
        <span class="k">if</span> <span class="n">logging_name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logging_name</span> <span class="o">=</span> <span class="n">logging_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">echo</span> <span class="o">=</span> <span class="n">echo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hide_parameters</span> <span class="o">=</span> <span class="n">hide_parameters</span>
        <span class="k">if</span> <span class="n">query_cache_size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compiled_cache</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">LRUCache</span><span class="p">(</span>
                <span class="n">query_cache_size</span><span class="p">,</span> <span class="n">size_alert</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_lru_size_alert</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compiled_cache</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">log</span><span class="o">.</span><span class="n">instance_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">echoflag</span><span class="o">=</span><span class="n">echo</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">execution_options</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_execution_options</span><span class="p">(</span><span class="o">**</span><span class="n">execution_options</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_lru_size_alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache</span><span class="p">:</span> <span class="n">util</span><span class="o">.</span><span class="n">LRUCache</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_log_info</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Compiled cache size pruning from </span><span class="si">%d</span><span class="s2"> items to </span><span class="si">%d</span><span class="s2">.  &quot;</span>
                <span class="s2">&quot;Increase cache size to reduce the frequency of pruning.&quot;</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">cache</span><span class="p">),</span>
                <span class="n">cache</span><span class="o">.</span><span class="n">capacity</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">engine</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Engine</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns this :class:`.Engine`.</span>

<span class="sd">        Used for legacy schemes that accept :class:`.Connection` /</span>
<span class="sd">        :class:`.Engine` objects within the same variable.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">clear_compiled_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear the compiled cache associated with the dialect.</span>

<span class="sd">        This applies **only** to the built-in cache that is established</span>
<span class="sd">        via the :paramref:`_engine.create_engine.query_cache_size` parameter.</span>
<span class="sd">        It will not impact any dictionary caches that were passed via the</span>
<span class="sd">        :paramref:`.Connection.execution_options.query_cache` parameter.</span>

<span class="sd">        .. versionadded:: 1.4</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compiled_cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compiled_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">update_execution_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">opt</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Update the default execution_options dictionary</span>
<span class="sd">        of this :class:`_engine.Engine`.</span>

<span class="sd">        The given keys/values in \**opt are added to the</span>
<span class="sd">        default execution options that will be used for</span>
<span class="sd">        all connections.  The initial contents of this dictionary</span>
<span class="sd">        can be sent via the ``execution_options`` parameter</span>
<span class="sd">        to :func:`_sa.create_engine`.</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            :meth:`_engine.Connection.execution_options`</span>

<span class="sd">            :meth:`_engine.Engine.execution_options`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">set_engine_execution_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_execution_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execution_options</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">set_engine_execution_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">)</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">execution_options</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">compiled_cache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CompiledCacheType</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
        <span class="n">logging_token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
        <span class="n">isolation_level</span><span class="p">:</span> <span class="n">IsolationLevel</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
        <span class="n">insertmanyvalues_page_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
        <span class="n">schema_translate_map</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SchemaTranslateMapType</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
        <span class="o">**</span><span class="n">opt</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OptionEngine</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span> <span class="nf">execution_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">opt</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OptionEngine</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">execution_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">opt</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">OptionEngine</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a new :class:`_engine.Engine` that will provide</span>
<span class="sd">        :class:`_engine.Connection` objects with the given execution options.</span>

<span class="sd">        The returned :class:`_engine.Engine` remains related to the original</span>
<span class="sd">        :class:`_engine.Engine` in that it shares the same connection pool and</span>
<span class="sd">        other state:</span>

<span class="sd">        * The :class:`_pool.Pool` used by the new :class:`_engine.Engine`</span>
<span class="sd">          is the</span>
<span class="sd">          same instance.  The :meth:`_engine.Engine.dispose`</span>
<span class="sd">          method will replace</span>
<span class="sd">          the connection pool instance for the parent engine as well</span>
<span class="sd">          as this one.</span>
<span class="sd">        * Event listeners are &quot;cascaded&quot; - meaning, the new</span>
<span class="sd">          :class:`_engine.Engine`</span>
<span class="sd">          inherits the events of the parent, and new events can be associated</span>
<span class="sd">          with the new :class:`_engine.Engine` individually.</span>
<span class="sd">        * The logging configuration and logging_name is copied from the parent</span>
<span class="sd">          :class:`_engine.Engine`.</span>

<span class="sd">        The intent of the :meth:`_engine.Engine.execution_options` method is</span>
<span class="sd">        to implement schemes where multiple :class:`_engine.Engine`</span>
<span class="sd">        objects refer to the same connection pool, but are differentiated</span>
<span class="sd">        by options that affect some execution-level behavior for each</span>
<span class="sd">        engine.    One such example is breaking into separate &quot;reader&quot; and</span>
<span class="sd">        &quot;writer&quot; :class:`_engine.Engine` instances, where one</span>
<span class="sd">        :class:`_engine.Engine`</span>
<span class="sd">        has a lower :term:`isolation level` setting configured or is even</span>
<span class="sd">        transaction-disabled using &quot;autocommit&quot;.  An example of this</span>
<span class="sd">        configuration is at :ref:`dbapi_autocommit_multiple`.</span>

<span class="sd">        Another example is one that</span>
<span class="sd">        uses a custom option ``shard_id`` which is consumed by an event</span>
<span class="sd">        to change the current schema on a database connection::</span>

<span class="sd">            from sqlalchemy import event</span>
<span class="sd">            from sqlalchemy.engine import Engine</span>

<span class="sd">            primary_engine = create_engine(&quot;mysql+mysqldb://&quot;)</span>
<span class="sd">            shard1 = primary_engine.execution_options(shard_id=&quot;shard1&quot;)</span>
<span class="sd">            shard2 = primary_engine.execution_options(shard_id=&quot;shard2&quot;)</span>

<span class="sd">            shards = {&quot;default&quot;: &quot;base&quot;, &quot;shard_1&quot;: &quot;db1&quot;, &quot;shard_2&quot;: &quot;db2&quot;}</span>

<span class="sd">            @event.listens_for(Engine, &quot;before_cursor_execute&quot;)</span>
<span class="sd">            def _switch_shard(conn, cursor, stmt,</span>
<span class="sd">                    params, context, executemany):</span>
<span class="sd">                shard_id = conn.get_execution_options().get(&#39;shard_id&#39;, &quot;default&quot;)</span>
<span class="sd">                current_shard = conn.info.get(&quot;current_shard&quot;, None)</span>

<span class="sd">                if current_shard != shard_id:</span>
<span class="sd">                    cursor.execute(&quot;use %s&quot; % shards[shard_id])</span>
<span class="sd">                    conn.info[&quot;current_shard&quot;] = shard_id</span>

<span class="sd">        The above recipe illustrates two :class:`_engine.Engine` objects that</span>
<span class="sd">        will each serve as factories for :class:`_engine.Connection` objects</span>
<span class="sd">        that have pre-established &quot;shard_id&quot; execution options present. A</span>
<span class="sd">        :meth:`_events.ConnectionEvents.before_cursor_execute` event handler</span>
<span class="sd">        then interprets this execution option to emit a MySQL ``use`` statement</span>
<span class="sd">        to switch databases before a statement execution, while at the same</span>
<span class="sd">        time keeping track of which database we&#39;ve established using the</span>
<span class="sd">        :attr:`_engine.Connection.info` dictionary.</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            :meth:`_engine.Connection.execution_options`</span>
<span class="sd">            - update execution options</span>
<span class="sd">            on a :class:`_engine.Connection` object.</span>

<span class="sd">            :meth:`_engine.Engine.update_execution_options`</span>
<span class="sd">            - update the execution</span>
<span class="sd">            options for a given :class:`_engine.Engine` in place.</span>

<span class="sd">            :meth:`_engine.Engine.get_execution_options`</span>


<span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_option_cls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_execution_options</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_ExecuteOptions</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the non-SQL options which will take effect during execution.</span>

<span class="sd">        .. versionadded: 1.3</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            :meth:`_engine.Engine.execution_options`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execution_options</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;String name of the :class:`~sqlalchemy.engine.interfaces.Dialect`</span>
<span class="sd">        in use by this :class:`Engine`.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">driver</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Driver name of the :class:`~sqlalchemy.engine.interfaces.Dialect`</span>
<span class="sd">        in use by this :class:`Engine`.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">driver</span>

    <span class="n">echo</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">echo_property</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Engine(</span><span class="si">%r</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">dispose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">close</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dispose of the connection pool used by this</span>
<span class="sd">        :class:`_engine.Engine`.</span>

<span class="sd">        A new connection pool is created immediately after the old one has been</span>
<span class="sd">        disposed. The previous connection pool is disposed either actively, by</span>
<span class="sd">        closing out all currently checked-in connections in that pool, or</span>
<span class="sd">        passively, by losing references to it but otherwise not closing any</span>
<span class="sd">        connections. The latter strategy is more appropriate for an initializer</span>
<span class="sd">        in a forked Python process.</span>

<span class="sd">        :param close: if left at its default of ``True``, has the</span>
<span class="sd">         effect of fully closing all **currently checked in**</span>
<span class="sd">         database connections.  Connections that are still checked out</span>
<span class="sd">         will **not** be closed, however they will no longer be associated</span>
<span class="sd">         with this :class:`_engine.Engine`,</span>
<span class="sd">         so when they are closed individually, eventually the</span>
<span class="sd">         :class:`_pool.Pool` which they are associated with will</span>
<span class="sd">         be garbage collected and they will be closed out fully, if</span>
<span class="sd">         not already closed on checkin.</span>

<span class="sd">         If set to ``False``, the previous connection pool is de-referenced,</span>
<span class="sd">         and otherwise not touched in any way.</span>

<span class="sd">        .. versionadded:: 1.4.33  Added the :paramref:`.Engine.dispose.close`</span>
<span class="sd">            parameter to allow the replacement of a connection pool in a child</span>
<span class="sd">            process without interfering with the connections used by the parent</span>
<span class="sd">            process.</span>


<span class="sd">        .. seealso::</span>

<span class="sd">            :ref:`engine_disposal`</span>

<span class="sd">            :ref:`pooling_multiprocessing`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">close</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">recreate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">engine_disposed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">_optional_conn_ctx_manager</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Connection</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Connection</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">connection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">conn</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">connection</span>

    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">begin</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Connection</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a context manager delivering a :class:`_engine.Connection`</span>
<span class="sd">        with a :class:`.Transaction` established.</span>

<span class="sd">        E.g.::</span>

<span class="sd">            with engine.begin() as conn:</span>
<span class="sd">                conn.execute(</span>
<span class="sd">                    text(&quot;insert into table (x, y, z) values (1, 2, 3)&quot;)</span>
<span class="sd">                )</span>
<span class="sd">                conn.execute(text(&quot;my_special_procedure(5)&quot;))</span>

<span class="sd">        Upon successful operation, the :class:`.Transaction`</span>
<span class="sd">        is committed.  If an error is raised, the :class:`.Transaction`</span>
<span class="sd">        is rolled back.</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            :meth:`_engine.Engine.connect` - procure a</span>
<span class="sd">            :class:`_engine.Connection` from</span>
<span class="sd">            an :class:`_engine.Engine`.</span>

<span class="sd">            :meth:`_engine.Connection.begin` - start a :class:`.Transaction`</span>
<span class="sd">            for a particular :class:`_engine.Connection`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">conn</span><span class="o">.</span><span class="n">begin</span><span class="p">():</span>
                <span class="k">yield</span> <span class="n">conn</span>

    <span class="k">def</span> <span class="nf">_run_ddl_visitor</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">visitorcallable</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">SchemaGenerator</span><span class="p">,</span> <span class="n">SchemaDropper</span><span class="p">]],</span>
        <span class="n">element</span><span class="p">:</span> <span class="n">SchemaItem</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">_run_ddl_visitor</span><span class="p">(</span><span class="n">visitorcallable</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Connection</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a new :class:`_engine.Connection` object.</span>

<span class="sd">        The :class:`_engine.Connection` acts as a Python context manager, so</span>
<span class="sd">        the typical use of this method looks like::</span>

<span class="sd">            with engine.connect() as connection:</span>
<span class="sd">                connection.execute(text(&quot;insert into table values (&#39;foo&#39;)&quot;))</span>
<span class="sd">                connection.commit()</span>

<span class="sd">        Where above, after the block is completed, the connection is &quot;closed&quot;</span>
<span class="sd">        and its underlying DBAPI resources are returned to the connection pool.</span>
<span class="sd">        This also has the effect of rolling back any transaction that</span>
<span class="sd">        was explicitly begun or was begun via autobegin, and will</span>
<span class="sd">        emit the :meth:`_events.ConnectionEvents.rollback` event if one was</span>
<span class="sd">        started and is still in progress.</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            :meth:`_engine.Engine.begin`</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection_cls</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">raw_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PoolProxiedConnection</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a &quot;raw&quot; DBAPI connection from the connection pool.</span>

<span class="sd">        The returned object is a proxied version of the DBAPI</span>
<span class="sd">        connection object used by the underlying driver in use.</span>
<span class="sd">        The object will have all the same behavior as the real DBAPI</span>
<span class="sd">        connection, except that its ``close()`` method will result in the</span>
<span class="sd">        connection being returned to the pool, rather than being closed</span>
<span class="sd">        for real.</span>

<span class="sd">        This method provides direct DBAPI connection access for</span>
<span class="sd">        special situations when the API provided by</span>
<span class="sd">        :class:`_engine.Connection`</span>
<span class="sd">        is not needed.   When a :class:`_engine.Connection` object is already</span>
<span class="sd">        present, the DBAPI connection is available using</span>
<span class="sd">        the :attr:`_engine.Connection.connection` accessor.</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            :ref:`dbapi_connections`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">OptionEngineMixin</span><span class="p">(</span><span class="n">log</span><span class="o">.</span><span class="n">Identified</span><span class="p">):</span>
    <span class="n">_sa_propagate_class_events</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">dispatch</span><span class="p">:</span> <span class="n">dispatcher</span><span class="p">[</span><span class="n">ConnectionEventsTarget</span><span class="p">]</span>
    <span class="n">_compiled_cache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CompiledCacheType</span><span class="p">]</span>
    <span class="n">dialect</span><span class="p">:</span> <span class="n">Dialect</span>
    <span class="n">pool</span><span class="p">:</span> <span class="n">Pool</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">URL</span>
    <span class="n">hide_parameters</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">echo</span><span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">echo_property</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">proxied</span><span class="p">:</span> <span class="n">Engine</span><span class="p">,</span> <span class="n">execution_options</span><span class="p">:</span> <span class="n">CoreExecuteOptionsParameter</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_proxied</span> <span class="o">=</span> <span class="n">proxied</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">proxied</span><span class="o">.</span><span class="n">url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span> <span class="o">=</span> <span class="n">proxied</span><span class="o">.</span><span class="n">dialect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logging_name</span> <span class="o">=</span> <span class="n">proxied</span><span class="o">.</span><span class="n">logging_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">echo</span> <span class="o">=</span> <span class="n">proxied</span><span class="o">.</span><span class="n">echo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compiled_cache</span> <span class="o">=</span> <span class="n">proxied</span><span class="o">.</span><span class="n">_compiled_cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hide_parameters</span> <span class="o">=</span> <span class="n">proxied</span><span class="o">.</span><span class="n">hide_parameters</span>
        <span class="n">log</span><span class="o">.</span><span class="n">instance_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">echoflag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">echo</span><span class="p">)</span>

        <span class="c1"># note: this will propagate events that are assigned to the parent</span>
        <span class="c1"># engine after this OptionEngine is created.   Since we share</span>
        <span class="c1"># the events of the parent we also disallow class-level events</span>
        <span class="c1"># to apply to the OptionEngine class directly.</span>
        <span class="c1">#</span>
        <span class="c1"># the other way this can work would be to transfer existing</span>
        <span class="c1"># events only, using:</span>
        <span class="c1"># self.dispatch._update(proxied.dispatch)</span>
        <span class="c1">#</span>
        <span class="c1"># that might be more appropriate however it would be a behavioral</span>
        <span class="c1"># change for logic that assigns events to the parent engine and</span>
        <span class="c1"># would like it to take effect for the already-created sub-engine.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">_join</span><span class="p">(</span><span class="n">proxied</span><span class="o">.</span><span class="n">dispatch</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_execution_options</span> <span class="o">=</span> <span class="n">proxied</span><span class="o">.</span><span class="n">_execution_options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_execution_options</span><span class="p">(</span><span class="o">**</span><span class="n">execution_options</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_execution_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">opt</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">typing</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>
        <span class="c1"># https://github.com/python/typing/discussions/1095</span>

        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">pool</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Pool</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proxied</span><span class="o">.</span><span class="n">pool</span>

        <span class="nd">@pool</span><span class="o">.</span><span class="n">setter</span>
        <span class="k">def</span> <span class="nf">pool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pool</span><span class="p">:</span> <span class="n">Pool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_proxied</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">pool</span>

        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">_has_events</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proxied</span><span class="o">.</span><span class="n">_has_events</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;_has_events&quot;</span><span class="p">,</span> <span class="kc">False</span>
            <span class="p">)</span>

        <span class="nd">@_has_events</span><span class="o">.</span><span class="n">setter</span>
        <span class="k">def</span> <span class="nf">_has_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;_has_events&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">OptionEngine</span><span class="p">(</span><span class="n">OptionEngineMixin</span><span class="p">,</span> <span class="n">Engine</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">update_execution_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">opt</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Engine</span><span class="o">.</span><span class="n">update_execution_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">opt</span><span class="p">)</span>


<span class="n">Engine</span><span class="o">.</span><span class="n">_option_cls</span> <span class="o">=</span> <span class="n">OptionEngine</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">zenq</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html">zenq</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">zenq</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../authors.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../history.html">History</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, Nare Abgaryan.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 6.0.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
    </div>

    

    
  </body>
</html>